<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†æˆ·æ§åˆ¶å° | Onerway</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-responsive-min.css">
    <link rel="stylesheet" href="../css/lite-main.css">
</head>
<body>
    <div class="nav-container">
        <div class="container">
            <ul class="nav">
                <li class="nav-item"><a class="nav-link active" href="dashboard.html">æ§åˆ¶å°</a></li>
                <li class="nav-item"><a class="nav-link" href="manage-links.html">ç®¡ç†é“¾æ¥</a></li>
            </ul>
        </div>
    </div>

    <div class="container">
        <div class="header-actions">
            <h2>æ§åˆ¶å°</h2>
            <div class="dropdown">
                <button id="createLinkBtn" class="pure-button primary-button dropdown-toggle">
                    åˆ›å»ºæ–°é“¾æ¥ <span class="dropdown-arrow">â–¼</span>
                </button>
                <div class="dropdown-menu">
                    <a href="#" class="dropdown-item" id="createPaymentLink">æ”¯ä»˜é“¾æ¥</a>
                    <a href="#" class="dropdown-item" id="createManualPayment">æ‰‹åŠ¨ä»˜æ¬¾</a>
                    <a href="#" class="dropdown-item" id="createDynamicPayment">åŠ¨æ€é‡‘é¢ä»˜æ¬¾</a>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®æ¦‚è§ˆ -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <div class="stat-content">
                            <div class="stat-icon">ğŸ’°</div>
                            <div class="stat-info">
                                <h3 id="totalLinks">0</h3>
                                <p>æ´»è·ƒé“¾æ¥</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <div class="stat-content">
                            <div class="stat-icon">ğŸ‘ï¸</div>
                            <div class="stat-info">
                                <h3 id="totalVisits">0</h3>
                                <p>æ€»è®¿é—®</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <div class="stat-content">
                            <div class="stat-icon">âœ…</div>
                            <div class="stat-info">
                                <h3 id="totalConversions">0</h3>
                                <p>æˆåŠŸæ”¯ä»˜</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æœ€è¿‘é“¾æ¥ -->
        <div class="card">
            <div class="card-header">
                <h3>æœ€è¿‘é“¾æ¥</h3>
                <a href="manage-links.html" class="pure-button secondary-button">æŸ¥çœ‹å…¨éƒ¨</a>
            </div>
            <div class="card-body">
                <table class="pure-table pure-table-bordered">
                    <thead>
                        <tr>
                            <th>å•†å“ç¼–å·</th>
                            <th>åç§°</th>
                            <th>é‡‘é¢</th>
                            <th>åˆ›å»ºæ—¥æœŸ</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="recentLinksTable">
                        <tr>
                            <td colspan="4" class="text-center">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- æœ€è¿‘äº¤æ˜“ -->
        <div class="card">
            <div class="card-header">
                <h3>æœ€è¿‘äº¤æ˜“</h3>
            </div>
            <div class="card-body">
                <table class="pure-table pure-table-bordered">
                    <thead>
                        <tr>
                            <th>äº¤æ˜“ID</th>
                            <th>å•†å“åç§°</th>
                            <th>é‡‘é¢</th>
                            <th>æ”¯ä»˜æ–¹å¼</th>
                            <th>æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody id="recentTransactionsTable">
                        <tr>
                            <td colspan="4" class="text-center">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- åœ¨æ§åˆ¶å°é¡µé¢æ·»åŠ åˆ›å»ºé“¾æ¥æ¨¡æ€æ¡† -->
    <div id="createLinkModal" class="pure-modal">
        <div class="pure-modal-overlay" onclick="closeModal()"></div>
        <div class="pure-modal-container">
            <div class="pure-modal-header">
                <h4>åˆ›å»ºæ”¯ä»˜é“¾æ¥</h4>
                <button class="pure-modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="pure-modal-body">
                <form id="createLinkForm" class="pure-form pure-form-stacked">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <h5>åŸºç¡€ä¿¡æ¯</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label for="title">å•†å“åç§° *</label>
                        <input type="text" id="title" class="form-control" required maxlength="50">
                        <small>æœ€å¤š50ä¸ªå­—ç¬¦</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">å•†å“æè¿°</label>
                        <textarea id="description" class="form-control" rows="3" maxlength="200"></textarea>
                        <small>æœ€å¤š200ä¸ªå­—ç¬¦ï¼Œæè¿°ä»…æ˜¾ç¤ºåœ¨å•†æˆ·ç®¡ç†ç•Œé¢ï¼Œä¸ä¼šå±•ç¤ºç»™å®¢æˆ·ã€‚</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="image">å•†å“å›¾ç‰‡</label>
                        <input type="file" id="image" class="form-control" accept="image/png, image/jpeg">
                        <small>æ”¯æŒJPG/PNGï¼Œæœ€å¤§2MB</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="productCode">å•†å“ç¼–å· *</label>
                        <input type="text" id="productCode" class="form-control" required maxlength="20">
                        <small>è¾“å…¥å”¯ä¸€å•†å“ç¼–å·ï¼Œä¸å¯é‡å¤</small>
                    </div>
                    
                    <!-- é‡‘é¢è®¾ç½® -->
                    <h5 style="margin-top: 20px;">é‡‘é¢è®¾ç½® *</h5>
                    <hr>
                    
                    <div class="form-group">
                        <div class="pure-g">
                            <div class="pure-u-1-2">
                                <label class="pure-radio">
                                    <input type="radio" name="amountType" value="FIXED" checked> å›ºå®šé‡‘é¢
                                </label>
                            </div>
                            <div class="pure-u-1-2">
                                <label class="pure-radio">
                                    <input type="radio" name="amountType" value="DYNAMIC"> å®¢æˆ·è‡ªå®šä¹‰é‡‘é¢
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="fixedAmountFields">
                        <div class="pure-g">
                            <div class="pure-u-1-3">
                                <div class="form-group">
                                    <label for="amount">å•ä»· *</label>
                                    <input type="number" id="amount" class="form-control" step="0.01" min="0.01" required>
                                </div>
                            </div>
                            <div class="pure-u-1-3">
                                <div class="form-group">
                                    <label for="quantity">å•†å“æ•°é‡ *</label>
                                    <input type="number" id="quantity" class="form-control" min="1" value="1" required>
                                </div>
                            </div>
                            <div class="pure-u-1-3">
                                <div class="form-group">
                                    <label for="currency">è´§å¸ *</label>
                                    <select id="currency" class="form-control" required>
                                        <option value="USD">ç¾å…ƒ (USD)</option>
                                        <option value="EUR">æ¬§å…ƒ (EUR)</option>
                                        <option value="JPY">æ—¥å…ƒ (JPY)</option>
                                        <option value="CNY">äººæ°‘å¸ (CNY)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="dynamicAmountFields" style="display: none;">
                        <div class="pure-g">
                            <div class="pure-u-1-3">
                                <div class="form-group">
                                    <label for="minAmount">æœ€å°é‡‘é¢</label>
                                    <input type="number" id="minAmount" class="form-control" step="0.01" min="0.01">
                                </div>
                            </div>
                            <div class="pure-u-1-3">
                                <div class="form-group">
                                    <label for="maxAmount">æœ€å¤§é‡‘é¢</label>
                                    <input type="number" id="maxAmount" class="form-control" step="0.01" min="0.01">
                                </div>
                            </div>
                            <div class="pure-u-1-3">
                                <div class="form-group">
                                    <label for="dynamicCurrency">è´§å¸ *</label>
                                    <select id="dynamicCurrency" class="form-control" required>
                                        <option value="USD">ç¾å…ƒ (USD)</option>
                                        <option value="EUR">æ¬§å…ƒ (EUR)</option>
                                        <option value="JPY">æ—¥å…ƒ (JPY)</option>
                                        <option value="CNY">äººæ°‘å¸ (CNY)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é«˜çº§è®¾ç½® -->
                    <h5 style="margin-top: 20px;">é«˜çº§è®¾ç½®</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label>æœ‰æ•ˆæœŸè®¾ç½®</label>
                        <div class="pure-g">
                            <div class="pure-u-1-2">
                                <label class="pure-radio">
                                    <input type="radio" name="validityType" value="PERMANENT" checked> æ°¸ä¹…æœ‰æ•ˆ
                                </label>
                            </div>
                            <div class="pure-u-1-2">
                                <label class="pure-radio">
                                    <input type="radio" name="validityType" value="FIXED"> è®¾ç½®æœ‰æ•ˆæœŸ
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="validityFields" style="display: none;">
                        <div class="pure-g">
                            <div class="pure-u-1-2">
                                <div class="form-group">
                                    <label for="endDate">æˆªæ­¢æ—¥æœŸ</label>
                                    <input type="date" id="endDate" class="form-control">
                                </div>
                            </div>
                            <div class="pure-u-1-2">
                                <div class="form-group">
                                    <label for="maxUsage">ä½¿ç”¨æ¬¡æ•°é™åˆ¶</label>
                                    <input type="number" id="maxUsage" class="form-control" min="1" max="1000">
                                    <small>ç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶æ¬¡æ•°</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>æ”¯ä»˜æ–¹å¼</label>
                        <div class="alert alert-info">
                            é»˜è®¤æ”¯æŒæ‰€æœ‰å¯ç”¨çš„æ”¯ä»˜æ–¹å¼ï¼ŒåŒ…æ‹¬ä¿¡ç”¨å¡æ”¯ä»˜ã€Apple Payå’Œæœ¬åœ°æ”¯ä»˜æ–¹å¼ã€‚
                        </div>
                    </div>
                </form>
            </div>
            <div class="pure-modal-footer">
                <button type="button" class="pure-button secondary-button" onclick="closeModal()">å–æ¶ˆ</button>
                <button type="button" class="pure-button primary-button" id="submitLinkForm">åˆ›å»ºé“¾æ¥</button>
            </div>
        </div>
    </div>

    <!-- åœ¨é¡µé¢åº•éƒ¨æ·»åŠ æ‰‹åŠ¨ä»˜æ¬¾æ¨¡æ€æ¡† -->
    <div id="manualPaymentModal" class="pure-modal">
        <div class="pure-modal-overlay" onclick="closeManualModal()"></div>
        <div class="pure-modal-container">
            <div class="pure-modal-header">
                <h4>æ‰‹åŠ¨ä»˜æ¬¾</h4>
                <button class="pure-modal-close" onclick="closeManualModal()">Ã—</button>
            </div>
            <div class="pure-modal-body">
                <form id="manualPaymentForm" class="pure-form pure-form-stacked">
                    <!-- å•†å“ä¿¡æ¯ -->
                    <h5>å•†å“ä¿¡æ¯</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label for="manual_title">å•†å“åç§° *</label>
                        <input type="text" id="manual_title" class="form-control" required maxlength="50">
                    </div>
                    
                    <div class="form-group">
                        <label for="manual_productCode">å•†å“ç¼–å· *</label>
                        <input type="text" id="manual_productCode" class="form-control" required maxlength="20">
                        <small>è¾“å…¥å”¯ä¸€å•†å“ç¼–å·ï¼Œä¸å¯é‡å¤</small>
                    </div>
                    
                    <div class="pure-g">
                        <div class="pure-u-1-2">
                            <div class="form-group">
                                <label for="manual_amount">é‡‘é¢ *</label>
                                <input type="number" id="manual_amount" class="form-control" step="0.01" min="0.01" required>
                            </div>
                        </div>
                        <div class="pure-u-1-2">
                            <div class="form-group">
                                <label for="manual_currency">è´§å¸ *</label>
                                <select id="manual_currency" class="form-control" required>
                                    <option value="USD">ç¾å…ƒ (USD)</option>
                                    <option value="EUR">æ¬§å…ƒ (EUR)</option>
                                    <option value="JPY">æ—¥å…ƒ (JPY)</option>
                                    <option value="CNY">äººæ°‘å¸ (CNY)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å®¢æˆ·ä¿¡æ¯ -->
                    <h5 style="margin-top: 20px;">å®¢æˆ·ä¿¡æ¯</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label for="customer_name">å®¢æˆ·å§“å *</label>
                        <input type="text" id="customer_name" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer_email">å®¢æˆ·é‚®ç®±</label>
                        <input type="email" id="customer_email" class="form-control">
                    </div>
                    
                    <!-- å¡ç‰‡ä¿¡æ¯ -->
                    <h5 style="margin-top: 20px;">æ”¯ä»˜å¡ä¿¡æ¯</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label for="card_number">å¡å· *</label>
                        <input type="text" id="card_number" class="form-control" required placeholder="XXXX XXXX XXXX XXXX">
                    </div>
                    
                    <div class="pure-g">
                        <div class="pure-u-1-2">
                            <div class="form-group">
                                <label for="card_expiry">æœ‰æ•ˆæœŸ *</label>
                                <input type="text" id="card_expiry" class="form-control" required placeholder="MM/YY">
                            </div>
                        </div>
                        <div class="pure-u-1-2">
                            <div class="form-group">
                                <label for="card_cvc">å®‰å…¨ç  *</label>
                                <input type="text" id="card_cvc" class="form-control" required placeholder="CVC">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="pure-modal-footer">
                <button type="button" class="pure-button secondary-button" onclick="closeManualModal()">å–æ¶ˆ</button>
                <button type="button" class="pure-button primary-button" id="submitManualPayment">å¤„ç†ä»˜æ¬¾</button>
            </div>
        </div>
    </div>

    <!-- åœ¨é¡µé¢åº•éƒ¨æ·»åŠ åŠ¨æ€é‡‘é¢ä»˜æ¬¾æ¨¡æ€æ¡† -->
    <div id="dynamicPaymentModal" class="pure-modal">
        <div class="pure-modal-overlay" onclick="closeDynamicModal()"></div>
        <div class="pure-modal-container">
            <div class="pure-modal-header">
                <h4>åˆ›å»ºåŠ¨æ€é‡‘é¢ä»˜æ¬¾é“¾æ¥</h4>
                <button class="pure-modal-close" onclick="closeDynamicModal()">Ã—</button>
            </div>
            <div class="pure-modal-body">
                <form id="dynamicPaymentForm" class="pure-form pure-form-stacked">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <h5>åŸºç¡€ä¿¡æ¯</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label for="dynamic_title">å•†å“åç§° *</label>
                        <input type="text" id="dynamic_title" class="form-control" required maxlength="50">
                        <small>æœ€å¤š50ä¸ªå­—ç¬¦</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="dynamic_description">å•†å“æè¿°</label>
                        <textarea id="dynamic_description" class="form-control" rows="3" maxlength="200"></textarea>
                        <small>æœ€å¤š200ä¸ªå­—ç¬¦ï¼Œæè¿°ä»…æ˜¾ç¤ºåœ¨å•†æˆ·ç®¡ç†ç•Œé¢</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="dynamic_productCode">å•†å“ç¼–å· *</label>
                        <input type="text" id="dynamic_productCode" class="form-control" required maxlength="20">
                        <small>è¾“å…¥å”¯ä¸€å•†å“ç¼–å·ï¼Œä¸å¯é‡å¤</small>
                    </div>
                    
                    <!-- é‡‘é¢è®¾ç½® -->
                    <h5 style="margin-top: 20px;">é‡‘é¢è®¾ç½®</h5>
                    <hr>
                    
                    <div class="pure-g">
                        <div class="pure-u-1-3">
                            <div class="form-group">
                                <label for="dynamic_minAmount">æœ€å°é‡‘é¢</label>
                                <input type="number" id="dynamic_minAmount" class="form-control" step="0.01" min="0.01">
                            </div>
                        </div>
                        <div class="pure-u-1-3">
                            <div class="form-group">
                                <label for="dynamic_maxAmount">æœ€å¤§é‡‘é¢</label>
                                <input type="number" id="dynamic_maxAmount" class="form-control" step="0.01" min="0.01">
                            </div>
                        </div>
                        <div class="pure-u-1-3">
                            <div class="form-group">
                                <label for="dynamic_currency">è´§å¸ *</label>
                                <select id="dynamic_currency" class="form-control" required>
                                    <option value="USD">ç¾å…ƒ (USD)</option>
                                    <option value="EUR">æ¬§å…ƒ (EUR)</option>
                                    <option value="JPY">æ—¥å…ƒ (JPY)</option>
                                    <option value="CNY">äººæ°‘å¸ (CNY)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é«˜çº§è®¾ç½® -->
                    <h5 style="margin-top: 20px;">é«˜çº§è®¾ç½®</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label>æœ‰æ•ˆæœŸè®¾ç½®</label>
                        <div class="pure-g">
                            <div class="pure-u-1-2">
                                <label class="pure-radio">
                                    <input type="radio" name="dynamic_validityType" value="PERMANENT" checked> æ°¸ä¹…æœ‰æ•ˆ
                                </label>
                            </div>
                            <div class="pure-u-1-2">
                                <label class="pure-radio">
                                    <input type="radio" name="dynamic_validityType" value="FIXED"> è®¾ç½®æœ‰æ•ˆæœŸ
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="dynamicValidityFields" style="display: none;">
                        <div class="pure-g">
                            <div class="pure-u-1-2">
                                <div class="form-group">
                                    <label for="dynamic_endDate">æˆªæ­¢æ—¥æœŸ</label>
                                    <input type="date" id="dynamic_endDate" class="form-control">
                                </div>
                            </div>
                            <div class="pure-u-1-2">
                                <div class="form-group">
                                    <label for="dynamic_maxUsage">ä½¿ç”¨æ¬¡æ•°é™åˆ¶</label>
                                    <input type="number" id="dynamic_maxUsage" class="form-control" min="1" max="1000">
                                    <small>ç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶æ¬¡æ•°</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>æ”¯ä»˜æ–¹å¼</label>
                        <div class="alert alert-info">
                            é»˜è®¤æ”¯æŒæ‰€æœ‰å¯ç”¨çš„æ”¯ä»˜æ–¹å¼ï¼ŒåŒ…æ‹¬ä¿¡ç”¨å¡æ”¯ä»˜ã€Apple Payå’Œæœ¬åœ°æ”¯ä»˜æ–¹å¼ã€‚
                        </div>
                    </div>
                </form>
            </div>
            <div class="pure-modal-footer">
                <button type="button" class="pure-button secondary-button" onclick="closeDynamicModal()">å–æ¶ˆ</button>
                <button type="button" class="pure-button primary-button" id="submitDynamicPayment">åˆ›å»ºé“¾æ¥</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
    <script src="../js/storage.js"></script>
    <script>
        // æ·»åŠ ä»¥ä¸‹å‡½æ•°æ¥å¤„ç†æ¨¡æ€æ¡†å’Œä¸‹æ‹‰èœå•
        function showModal() {
            document.getElementById('createLinkModal').style.display = 'block';
            document.body.classList.add('modal-open');
        }
        
        function closeModal() {
            document.getElementById('createLinkModal').style.display = 'none';
            document.body.classList.remove('modal-open');
        }
        
        function showManualModal() {
            document.getElementById('manualPaymentModal').style.display = 'block';
            document.body.classList.add('modal-open');
        }
        
        function closeManualModal() {
            document.getElementById('manualPaymentModal').style.display = 'none';
            document.body.classList.remove('modal-open');
        }
        
        function showDynamicModal() {
            document.getElementById('dynamicPaymentModal').style.display = 'block';
            document.body.classList.add('modal-open');
        }
        
        function closeDynamicModal() {
            document.getElementById('dynamicPaymentModal').style.display = 'none';
            document.body.classList.remove('modal-open');
        }
        
        // åˆ‡æ¢ä¸‹æ‹‰èœå•æ˜¾ç¤ºçŠ¶æ€
        function toggleDropdown() {
            document.querySelector('.dropdown-menu').classList.toggle('show');
        }
        
        // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­ä¸‹æ‹‰èœå•
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-toggle') && !event.target.matches('.dropdown-arrow')) {
                var dropdowns = document.getElementsByClassName('dropdown-menu');
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // ç»Ÿè®¡æ•°æ®
            const links = getAllLinks();
            const activeLinks = links.filter(link => link.status === 'ACTIVE');
            const transactions = getAllTransactions();
            
            let totalVisits = 0;
            let totalConversions = 0;
            
            links.forEach(link => {
                totalVisits += link.stats.visits || 0;
                totalConversions += link.stats.conversions || 0;
            });
            
            document.getElementById('totalLinks').textContent = activeLinks.length;
            document.getElementById('totalVisits').textContent = totalVisits;
            document.getElementById('totalConversions').textContent = totalConversions;
            
            // æœ€è¿‘é“¾æ¥
            const recentLinksTable = document.getElementById('recentLinksTable');
            recentLinksTable.innerHTML = '';
            
            if (links.length === 0) {
                recentLinksTable.innerHTML = '<tr><td colspan="4" class="text-center">æš‚æ— æ•°æ®</td></tr>';
            } else {
                const recentLinks = [...links].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
                
                recentLinks.forEach(link => {
                    const amountText = link.amount.type === 'FIXED' 
                        ? formatAmount(link.amount.totalValue || link.amount.value, link.amount.currency)
                        : 'åŠ¨æ€é‡‘é¢';
                    
                    const statusBadge = link.status === 'ACTIVE' 
                        ? '<span class="badge badge-success">æ´»è·ƒ</span>'
                        : link.status === 'DISABLED'
                            ? '<span class="badge badge-secondary">å·²ç¦ç”¨</span>'
                            : '<span class="badge badge-danger">å·²è¿‡æœŸ</span>';
                    
                    recentLinksTable.innerHTML += `
                        <tr>
                            <td>${link.productCode || 'æ— '}</td>
                            <td><a href="link-details.html?id=${link.id}">${link.title}</a></td>
                            <td>${amountText}</td>
                            <td>${formatDate(link.createdAt)}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
            }
            
            // æœ€è¿‘äº¤æ˜“
            const recentTransactionsTable = document.getElementById('recentTransactionsTable');
            recentTransactionsTable.innerHTML = '';
            
            if (transactions.length === 0) {
                recentTransactionsTable.innerHTML = '<tr><td colspan="4" class="text-center">æš‚æ— æ•°æ®</td></tr>';
            } else {
                const recentTransactions = [...transactions].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
                
                recentTransactions.forEach(transaction => {
                    recentTransactionsTable.innerHTML += `
                        <tr>
                            <td>${transaction.id.substring(0, 8)}...</td>
                            <td>${transaction.productTitle || 'æœªçŸ¥å•†å“'}</td>
                            <td>${formatAmount(transaction.amount, transaction.currency)}</td>
                            <td>${transaction.paymentMethod}</td>
                            <td>${formatDate(transaction.createdAt)}</td>
                        </tr>
                    `;
                });
            }
            
            // å®æ—¶æ›´æ–°é¢„è§ˆ
            document.getElementById('title').addEventListener('input', function() {
                document.getElementById('previewTitle').textContent = this.value || 'é“¾æ¥æ ‡é¢˜';
            });
            
            document.getElementById('amount').addEventListener('input', function() {
                const amount = parseFloat(this.value) || 0;
                const currency = document.getElementById('currency').value;
                const formattedAmount = new Intl.NumberFormat('zh-CN', { 
                    style: 'currency', 
                    currency: currency 
                }).format(amount);
                
                document.getElementById('previewPrice').textContent = formattedAmount;
                document.getElementById('previewTotal').textContent = formattedAmount;
            });
            
            document.getElementById('currency').addEventListener('change', function() {
                const amount = parseFloat(document.getElementById('amount').value) || 0;
                const currency = this.value;
                const formattedAmount = new Intl.NumberFormat('zh-CN', { 
                    style: 'currency', 
                    currency: currency 
                }).format(amount);
                
                document.getElementById('previewPrice').textContent = formattedAmount;
                document.getElementById('previewTotal').textContent = formattedAmount;
            });
            
            // é‡‘é¢ç±»å‹åˆ‡æ¢
            document.querySelectorAll('input[name="amountType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'FIXED') {
                        document.getElementById('fixedAmountFields').style.display = 'block';
                        document.getElementById('dynamicAmountFields').style.display = 'none';
                    } else {
                        document.getElementById('fixedAmountFields').style.display = 'none';
                        document.getElementById('dynamicAmountFields').style.display = 'block';
                    }
                });
            });
            
            // æœ‰æ•ˆæœŸç±»å‹åˆ‡æ¢
            document.querySelectorAll('input[name="validityType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'PERMANENT') {
                        document.getElementById('validityFields').style.display = 'none';
                    } else {
                        document.getElementById('validityFields').style.display = 'block';
                    }
                });
            });
            
            // ä¸‹æ‹‰èœå•ç‚¹å‡»äº‹ä»¶
            document.getElementById('createLinkBtn').addEventListener('click', function(e) {
                e.preventDefault();
                toggleDropdown();
            });
            
            // æ”¯ä»˜é“¾æ¥é€‰é¡¹ç‚¹å‡»äº‹ä»¶
            document.getElementById('createPaymentLink').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelector('.dropdown-menu').classList.remove('show');
                showModal();
            });
            
            // æ‰‹åŠ¨ä»˜æ¬¾é€‰é¡¹ç‚¹å‡»äº‹ä»¶
            document.getElementById('createManualPayment').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelector('.dropdown-menu').classList.remove('show');
                showManualModal();
            });
            
            // åŠ¨æ€é‡‘é¢ä»˜æ¬¾é€‰é¡¹ç‚¹å‡»äº‹ä»¶
            document.getElementById('createDynamicPayment').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelector('.dropdown-menu').classList.remove('show');
                showDynamicModal();
            });
            
            // åŠ¨æ€é‡‘é¢æœ‰æ•ˆæœŸç±»å‹åˆ‡æ¢
            document.querySelectorAll('input[name="dynamic_validityType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'PERMANENT') {
                        document.getElementById('dynamicValidityFields').style.display = 'none';
                    } else {
                        document.getElementById('dynamicValidityFields').style.display = 'block';
                    }
                });
            });
            
            // å¤„ç†æ‰‹åŠ¨ä»˜æ¬¾æäº¤
            document.getElementById('submitManualPayment').addEventListener('click', function() {
                const form = document.getElementById('manualPaymentForm');
                
                // éªŒè¯è¡¨å•
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šå¤„ç†ä¿¡ç”¨å¡ä»˜æ¬¾
                // å½“å‰æ¼”ç¤ºç‰ˆæœ¬ï¼Œæˆ‘ä»¬åªæ˜¯è®°å½•ä¸€ä¸ªäº¤æ˜“
                
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„é“¾æ¥å¯¹è±¡ç”¨äºè®°å½•äº¤æ˜“
                const productCode = document.getElementById('manual_productCode').value;
                // æ£€æŸ¥å•†å“ç¼–å·å”¯ä¸€æ€§
                const links = getAllLinks();
                if (links.some(link => link.productCode === productCode)) {
                    alert('å•†å“ç¼–å·å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å”¯ä¸€çš„å•†å“ç¼–å·');
                    return;
                }
                
                const link = {
                    title: document.getElementById('manual_title').value,
                    description: "æ‰‹åŠ¨ä»˜æ¬¾äº¤æ˜“",
                    productCode: productCode,
                    amount: {
                        type: 'FIXED',
                        currency: document.getElementById('manual_currency').value,
                        value: parseFloat(document.getElementById('manual_amount').value),
                        quantity: 1
                    },
                    validity: {
                        type: 'PERMANENT'
                    },
                    paymentMethods: ["credit_card"]
                };
                
                link.amount.totalValue = link.amount.value;
                
                // ä¿å­˜é“¾æ¥
                const savedLink = saveLink(link);
                
                // è®°å½•äº¤æ˜“
                const transaction = {
                    linkId: savedLink.id,
                    merchantId: 'demo_merchant',
                    amount: link.amount.value,
                    currency: link.amount.currency,
                    paymentMethod: 'card',
                    status: 'completed',
                    customerInfo: {
                        email: document.getElementById('customer_email').value,
                        name: document.getElementById('customer_name').value,
                        card: '****' + document.getElementById('card_number').value.slice(-4)
                    }
                };
                
                recordTransaction(transaction);
                
                closeManualModal();
                
                alert('æ‰‹åŠ¨ä»˜æ¬¾å·²æˆåŠŸå¤„ç†ï¼');
                location.reload();
            });
            
            // å¤„ç†åŠ¨æ€é‡‘é¢é“¾æ¥æäº¤
            document.getElementById('submitDynamicPayment').addEventListener('click', function() {
                const form = document.getElementById('dynamicPaymentForm');
                
                // éªŒè¯è¡¨å•
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                // æ£€æŸ¥å•†å“ç¼–å·å”¯ä¸€æ€§
                const productCode = document.getElementById('dynamic_productCode').value;
                const links = getAllLinks();
                if (links.some(link => link.productCode === productCode)) {
                    alert('å•†å“ç¼–å·å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å”¯ä¸€çš„å•†å“ç¼–å·');
                    return;
                }
                
                const validityType = document.querySelector('input[name="dynamic_validityType"]:checked').value;
                
                // æ„å»ºé“¾æ¥å¯¹è±¡
                const link = {
                    title: document.getElementById('dynamic_title').value,
                    description: document.getElementById('dynamic_description').value,
                    productCode: productCode,
                    amount: {
                        type: 'DYNAMIC',
                        currency: document.getElementById('dynamic_currency').value,
                        minValue: parseFloat(document.getElementById('dynamic_minAmount').value) || 0.01,
                        maxValue: parseFloat(document.getElementById('dynamic_maxAmount').value) || 9999.99
                    },
                    validity: {
                        type: validityType
                    },
                    paymentMethods: ["credit_card", "apple_pay", "local_payments"]
                };
                
                if (validityType === 'FIXED') {
                    link.validity.endTime = document.getElementById('dynamic_endDate').value;
                    link.validity.maxUsage = parseInt(document.getElementById('dynamic_maxUsage').value) || null;
                }
                
                // ä¿å­˜é“¾æ¥
                const savedLink = saveLink(link);
                
                // ç”Ÿæˆæ”¯ä»˜é“¾æ¥URL
                const paymentUrl = `${window.location.origin}${window.location.pathname.replace('/merchant/dashboard.html', '')}/customer/payment.html?id=${savedLink.shortId}`;
                
                closeDynamicModal();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤ºå¹¶è·³è½¬åˆ°ç®¡ç†é“¾æ¥é¡µé¢
                alert(`åŠ¨æ€é‡‘é¢ä»˜æ¬¾é“¾æ¥å·²åˆ›å»ºæˆåŠŸï¼\né“¾æ¥: ${paymentUrl}`);
                window.location.href = 'manage-links.html';
            });
        });
    </script>
</body>
</html>
