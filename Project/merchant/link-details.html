<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“¾æ¥è¯¦æƒ… | Onerway</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/merchant.css">
    <link rel="stylesheet" href="../css/new-nav.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="../img/logo-sm.png" alt="Onerway Logo" class="sidebar-logo">
                <h3>å•†æˆ·ä¸­å¿ƒ</h3>
            </div>
            <ul class="sidebar-nav">
                <li class="sidebar-nav-item active">
                    <a href="dashboard.html" class="sidebar-nav-link">
                        <i class="nav-icon">ğŸ“Š</i>
                        <span>æ§åˆ¶å°</span>
                    </a>
                    <!-- æ§åˆ¶å°å­èœå• -->
                    <ul class="sidebar-subnav">
                        <li class="sidebar-subnav-item active">
                            <a href="manage-links.html" class="sidebar-subnav-link">ç®¡ç†é“¾æ¥</a>
                        </li>
                    </ul>
                </li>
                <!-- é¢„ç•™è®¢é˜…åŠŸèƒ½å¯¼èˆªå…¥å£ -->
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link">
                        <i class="nav-icon">ğŸ”„</i>
                        <span>è®¢é˜…ç®¡ç†</span>
                    </a>
                    <!-- è®¢é˜…ç®¡ç†å­èœå• -->
                    <ul class="sidebar-subnav" style="display: none;">
                        <li class="sidebar-subnav-item">
                            <a href="#" class="sidebar-subnav-link">è®¢é˜…é“¾æ¥</a>
                        </li>
                    </ul>
                </li>
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link">
                        <i class="nav-icon">âš™ï¸</i>
                        <span>è®¾ç½®</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="container mt-4">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="dashboard.html">æ§åˆ¶å°</a></li>
                                <li class="breadcrumb-item"><a href="manage-links.html">ç®¡ç†é“¾æ¥</a></li>
                                <li class="breadcrumb-item active" aria-current="page">é“¾æ¥è¯¦æƒ…</li>
                            </ol>
                        </nav>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h4 class="mb-0" id="linkTitle">åŠ è½½ä¸­...</h4>
                                <div class="btn-group">
                                    <button class="btn btn-outline-primary" id="shareBtn">
                                        <i class="bi bi-share"></i> åˆ†äº«
                                    </button>
                                    <button class="btn btn-outline-secondary" id="toggleStatusBtn">
                                        <i class="bi bi-pause-circle"></i> ç¦ç”¨
                                    </button>
                                    <button class="btn btn-outline-danger" id="deleteBtn">
                                        <i class="bi bi-trash"></i> åˆ é™¤
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>åŸºæœ¬ä¿¡æ¯</h5>
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                                <span>çŠ¶æ€</span>
                                                <span id="linkStatus" class="badge bg-success">æ´»è·ƒ</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                                <span>åˆ›å»ºæ—¶é—´</span>
                                                <span id="linkCreatedAt">--</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                                <span>é‡‘é¢ç±»å‹</span>
                                                <span id="linkAmountType">--</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                                <span>é‡‘é¢</span>
                                                <span id="linkAmount">--</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                                <span>æœ‰æ•ˆæœŸ</span>
                                                <span id="linkValidityType">--</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                                <span>æˆªæ­¢æ—¶é—´</span>
                                                <span id="linkEndTime">--</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                                <span>å•†å“ç¼–å·</span>
                                                <span id="linkProductCode">--</span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="productImage" class="text-center mb-3">
                                            <!-- å•†å“å›¾ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                        </div>
                                        <p id="linkDescription" class="text-muted">åŠ è½½ä¸­...</p>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <div class="row link-stats">
                                    <div class="col-md-4">
                                        <div class="stat-item">
                                            <div class="stat-number" id="linkVisits">0</div>
                                            <div class="stat-label">æ€»è®¿é—®æ¬¡æ•°</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stat-item">
                                            <div class="stat-number" id="linkConversions">0</div>
                                            <div class="stat-label">æ”¯ä»˜æ¬¡æ•°</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stat-item">
                                            <div class="stat-number" id="linkTotalAmount">Â¥0.00</div>
                                            <div class="stat-label">æ€»æ”¶æ¬¾é‡‘é¢</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-12">
                                        <canvas id="transactionsChart" height="200"></canvas>
                                    </div>
                                </div>
                                
                                <h5>äº¤æ˜“è®°å½•</h5>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>äº¤æ˜“ID</th>
                                                <th>é‡‘é¢</th>
                                                <th>æ”¯ä»˜æ–¹å¼</th>
                                                <th>æ—¶é—´</th>
                                                <th>çŠ¶æ€</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transactionsTable">
                                            <tr>
                                                <td colspan="5" class="text-center">åŠ è½½ä¸­...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">æ”¶æ¬¾é“¾æ¥</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="paymentLinkUrl" readonly>
                                        <button class="btn btn-outline-primary" type="button" id="copyLinkBtn">
                                            <i class="bi bi-clipboard"></i> å¤åˆ¶é“¾æ¥
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="text-center mb-3">
                                    <div id="linkQrCode" class="d-inline-block"></div>
                                </div>
                                
                                <div class="d-grid">
                                    <a href="#" class="btn btn-primary" id="testLinkBtn">
                                        <i class="bi bi-box-arrow-up-right"></i> æµ‹è¯•é“¾æ¥
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†äº«æ¨¡æ€æ¡† -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">åˆ†äº«æ”¯ä»˜é“¾æ¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>é€šè¿‡ä»¥ä¸‹æ–¹å¼åˆ†äº«æ‚¨çš„æ”¯ä»˜é“¾æ¥ï¼š</p>
                    <div class="d-grid gap-2">
                        <a href="#" class="btn btn-outline-primary" id="shareWhatsapp">
                            <i class="bi bi-whatsapp"></i> WhatsApp
                        </a>
                        <a href="#" class="btn btn-outline-primary" id="shareEmail">
                            <i class="bi bi-envelope"></i> ç”µå­é‚®ä»¶
                        </a>
                        <a href="#" class="btn btn-outline-primary" id="shareFacebook">
                            <i class="bi bi-facebook"></i> Facebook
                        </a>
                        <a href="#" class="btn btn-outline-primary" id="shareTwitter">
                            <i class="bi bi-twitter"></i> Twitter
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–é“¾æ¥ID
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            
            if (!id) {
                window.location.href = 'manage-links.html';
                return;
            }
            
            // è·å–é“¾æ¥ä¿¡æ¯
            const link = getLink(id);
            
            if (!link) {
                alert('é“¾æ¥ä¸å­˜åœ¨');
                window.location.href = 'manage-links.html';
                return;
            }
            
            // è®¾ç½®æ ‡é¢˜å’Œæè¿°
            document.getElementById('linkTitle').textContent = link.title;
            document.getElementById('linkDescription').textContent = link.description || 'æ— æè¿°';
            
            // è®¾ç½®çŠ¶æ€æ ‡ç­¾
            const statusElement = document.getElementById('linkStatus');
            if (link.status === 'ACTIVE') {
                statusElement.textContent = 'æ´»è·ƒ';
                statusElement.className = 'badge bg-success';
            } else if (link.status === 'DISABLED') {
                statusElement.textContent = 'å·²ç¦ç”¨';
                statusElement.className = 'badge bg-secondary';
            } else {
                statusElement.textContent = 'å·²è¿‡æœŸ';
                statusElement.className = 'badge bg-danger';
            }
            
            // è®¾ç½®åˆ‡æ¢çŠ¶æ€æŒ‰é’®æ–‡æœ¬
            const toggleBtn = document.getElementById('toggleStatusBtn');
            if (link.status === 'ACTIVE') {
                toggleBtn.innerHTML = '<i class="bi bi-pause-circle"></i> ç¦ç”¨';
                toggleBtn.classList.remove('btn-outline-success');
                toggleBtn.classList.add('btn-outline-secondary');
            } else {
                toggleBtn.innerHTML = '<i class="bi bi-play-circle"></i> å¯ç”¨';
                toggleBtn.classList.remove('btn-outline-secondary');
                toggleBtn.classList.add('btn-outline-success');
            }
            
            // è®¾ç½®åˆ›å»ºæ—¶é—´
            document.getElementById('linkCreatedAt').textContent = formatDate(link.createdAt);
            
            // è®¾ç½®é‡‘é¢ä¿¡æ¯
            document.getElementById('linkAmountType').textContent = link.amount.type === 'FIXED' ? 'å›ºå®šé‡‘é¢' : 'åŠ¨æ€é‡‘é¢';
            
            if (link.amount.type === 'FIXED') {
                if (link.amount.quantity && link.amount.quantity > 1) {
                    document.getElementById('linkAmount').textContent = 
                        `${formatAmount(link.amount.value, link.amount.currency)} Ã— ${link.amount.quantity} = ${formatAmount(link.amount.totalValue || (link.amount.value * link.amount.quantity), link.amount.currency)}`;
                } else {
                    document.getElementById('linkAmount').textContent = formatAmount(link.amount.value, link.amount.currency);
                }
            } else {
                document.getElementById('linkAmount').textContent = 
                    `${formatAmount(link.amount.minValue, link.amount.currency)} - ${formatAmount(link.amount.maxValue, link.amount.currency)}`;
            }
            
            // è®¾ç½®æœ‰æ•ˆæœŸä¿¡æ¯
            document.getElementById('linkValidityType').textContent = link.validity.type === 'PERMANENT' ? 'æ°¸ä¹…æœ‰æ•ˆ' : 'æŒ‡å®šæœŸé™';
            
            if (link.validity.type === 'FIXED' && link.validity.endTime) {
                document.getElementById('linkEndTime').textContent = formatDate(link.validity.endTime);
            } else {
                document.getElementById('linkEndTime').textContent = 'æ°¸ä¹…æœ‰æ•ˆ';
            }
            
            // è®¾ç½®å•†å“å›¾ç‰‡(å¦‚æœæœ‰)
            if (link.imageUrl) {
                const imgElement = document.createElement('img');
                imgElement.src = link.imageUrl;
                imgElement.alt = link.title;
                imgElement.className = 'img-fluid rounded';
                document.getElementById('productImage').appendChild(imgElement);
            }
            
            // ç»Ÿè®¡æ•°æ®
            document.getElementById('linkVisits').textContent = link.stats.visits || 0;
            document.getElementById('linkConversions').textContent = link.stats.conversions || 0;
            document.getElementById('linkTotalAmount').textContent = formatAmount(link.stats.totalAmount || 0, link.amount.currency);
            
            // è·å–äº¤æ˜“è®°å½•
            const transactions = getLinkTransactions(link.id);
            
            // æ˜¾ç¤ºäº¤æ˜“è®°å½•è¡¨æ ¼
            const transactionsTable = document.getElementById('transactionsTable');
            transactionsTable.innerHTML = '';
            
            if (transactions.length === 0) {
                transactionsTable.innerHTML = '<tr><td colspan="5" class="text-center">æš‚æ— äº¤æ˜“è®°å½•</td></tr>';
            } else {
                transactions.forEach(transaction => {
                    const statusBadge = transaction.status === 'completed' 
                        ? '<span class="badge bg-success">æˆåŠŸ</span>'
                        : '<span class="badge bg-warning">å¤„ç†ä¸­</span>';
                    
                    transactionsTable.innerHTML += `
                        <tr>
                            <td>${transaction.id}</td>
                            <td>${formatAmount(transaction.amount, transaction.currency)}</td>
                            <td>${transaction.paymentMethod}</td>
                            <td>${formatDate(transaction.createdAt)}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
            }
            
            // ç”Ÿæˆå›¾è¡¨
            if (transactions.length > 0) {
                // æŒ‰æ—¥æœŸåˆ†ç»„äº¤æ˜“
                const dateGroups = {};
                transactions.forEach(transaction => {
                    const date = new Date(transaction.createdAt).toLocaleDateString();
                    if (!dateGroups[date]) {
                        dateGroups[date] = 0;
                    }
                    dateGroups[date] += parseFloat(transaction.amount);
                });
                
                // åˆ›å»ºå›¾è¡¨æ•°æ®
                const labels = Object.keys(dateGroups);
                const data = Object.values(dateGroups);
                
                const ctx = document.getElementById('transactionsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ¯æ—¥äº¤æ˜“é‡‘é¢ (' + link.amount.currency + ')',
                            data: data,
                            backgroundColor: 'rgba(0, 102, 255, 0.2)',
                            borderColor: 'rgba(0, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } else {
                document.getElementById('transactionsChart').style.display = 'none';
            }
            
            // ç”Ÿæˆæ”¯ä»˜é“¾æ¥URL
            const paymentUrl = `${window.location.origin}${window.location.pathname.replace('/merchant/link-details.html', '')}/customer/payment.html?id=${link.shortId}`;
            document.getElementById('paymentLinkUrl').value = paymentUrl;
            
            // ç”ŸæˆäºŒç»´ç 
            const qrCodeImg = document.createElement('img');
            qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=128x128&data=${encodeURIComponent(paymentUrl)}`;
            qrCodeImg.alt = 'Payment QR Code';
            document.getElementById('linkQrCode').appendChild(qrCodeImg);
            
            // ç»‘å®šæµ‹è¯•é“¾æ¥æŒ‰é’®
            document.getElementById('testLinkBtn').href = paymentUrl;
            document.getElementById('testLinkBtn').target = '_blank';
            
            // å¤åˆ¶é“¾æ¥æŒ‰é’®
            document.getElementById('copyLinkBtn').addEventListener('click', function() {
                const linkInput = document.getElementById('paymentLinkUrl');
                linkInput.select();
                linkInput.setSelectionRange(0, 99999);
                document.execCommand('copy');
                this.innerHTML = '<i class="bi bi-check-lg"></i> å·²å¤åˆ¶';
                setTimeout(() => {
                    this.innerHTML = '<i class="bi bi-clipboard"></i> å¤åˆ¶é“¾æ¥';
                }, 2000);
            });
            
            // ç»‘å®šåˆ†äº«æŒ‰é’®
            document.getElementById('shareBtn').addEventListener('click', function() {
                if (navigator.share) {
                    navigator.share({
                        title: link.title,
                        text: link.description || 'é€šè¿‡æ­¤é“¾æ¥æ”¯ä»˜',
                        url: paymentUrl
                    }).catch(console.error);
                } else {
                    const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
                    shareModal.show();
                }
            });
            
            // ç»‘å®šåˆ†äº«é“¾æ¥
            document.getElementById('shareWhatsapp').href = `whatsapp://send?text=${encodeURIComponent(link.title + '\n' + paymentUrl)}`;
            document.getElementById('shareEmail').href = `mailto:?subject=${encodeURIComponent(link.title)}&body=${encodeURIComponent(paymentUrl)}`;
            document.getElementById('shareFacebook').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(paymentUrl)}`;
            document.getElementById('shareTwitter').href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(link.title)}&url=${encodeURIComponent(paymentUrl)}`;
            
            // ç»‘å®šåˆ‡æ¢çŠ¶æ€æŒ‰é’®
            document.getElementById('toggleStatusBtn').addEventListener('click', function() {
                const newStatus = link.status === 'ACTIVE' ? 'DISABLED' : 'ACTIVE';
                if (updateLinkStatus(link.id, newStatus)) {
                    location.reload();
                }
            });
            
            // ç»‘å®šåˆ é™¤æŒ‰é’®
            document.getElementById('deleteBtn').addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ”¯ä»˜é“¾æ¥å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
                    if (deleteLink(link.id)) {
                        alert('é“¾æ¥å·²æˆåŠŸåˆ é™¤');
                        window.location.href = 'manage-links.html';
                    }
                }
            });
            
            // è®¾ç½®å•†å“ç¼–å·
            document.getElementById('linkProductCode').textContent = link.productCode || 'æ— ';
        });
    </script>
</body>
</html> 