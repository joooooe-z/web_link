<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商户控制台 | Onerway</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-responsive-min.css">
    <link rel="stylesheet" href="../css/lite-main.css">
    <link rel="stylesheet" href="../css/new-nav.css">
</head>
<body>
    <div class="app-container">
        <!-- 左侧导航栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="../img/logo-sm.png" alt="Onerway Logo" class="sidebar-logo">
                <h3>商户中心</h3>
            </div>
            <ul class="sidebar-nav">
                <li class="sidebar-nav-item active">
                    <a href="dashboard.html" class="sidebar-nav-link">
                        <i class="nav-icon">📊</i>
                        <span>控制台</span>
                    </a>
                    <!-- 控制台子菜单 -->
                    <ul class="sidebar-subnav">
                        <li class="sidebar-subnav-item">
                            <a href="manage-links.html" class="sidebar-subnav-link">管理链接</a>
                        </li>
                    </ul>
                </li>
                <!-- 预留订阅功能导航入口 -->
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link">
                        <i class="nav-icon">🔄</i>
                        <span>订阅管理</span>
                    </a>
                    <!-- 订阅管理子菜单 -->
                    <ul class="sidebar-subnav" style="display: none;">
                        <li class="sidebar-subnav-item">
                            <a href="#" class="sidebar-subnav-link">订阅链接</a>
                        </li>
                        <li class="sidebar-subnav-item">
                            <a href="#" class="sidebar-subnav-link">订阅记录</a>
                        </li>
                    </ul>
                </li>
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link">
                        <i class="nav-icon">⚙️</i>
                        <span>设置</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <div class="container">
                <div class="header-actions">
                    <h2>控制台</h2>
                    <div class="dropdown">
                        <button id="createLinkBtn" class="pure-button primary-button dropdown-toggle">
                            创建新链接 <span class="dropdown-arrow">▼</span>
                        </button>
                        <div class="dropdown-menu">
                            <a href="#" class="dropdown-item" id="createPaymentLink">支付链接</a>
                            <a href="#" class="dropdown-item" id="createManualPayment">手动付款</a>
                            <a href="#" class="dropdown-item" id="createDynamicPayment">动态金额付款</a>
                        </div>
                    </div>
                </div>
                
                <!-- 数据概览 -->
                <div class="row">
                    <div class="col">
                        <div class="card">
                            <div class="card-body">
                                <div class="stat-content">
                                    <div class="stat-icon">💰</div>
                                    <div class="stat-info">
                                        <h3 id="totalLinks">0</h3>
                                        <p>活跃链接</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card">
                            <div class="card-body">
                                <div class="stat-content">
                                    <div class="stat-icon">👁️</div>
                                    <div class="stat-info">
                                        <h3 id="totalVisits">0</h3>
                                        <p>总访问</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card">
                            <div class="card-body">
                                <div class="stat-content">
                                    <div class="stat-icon">✅</div>
                                    <div class="stat-info">
                                        <h3 id="totalConversions">0</h3>
                                        <p>成功支付</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 最近链接 -->
                <div class="card">
                    <div class="card-header">
                        <h3>最近链接</h3>
                        <a href="manage-links.html" class="pure-button secondary-button">查看全部</a>
                    </div>
                    <div class="card-body">
                        <table class="pure-table pure-table-bordered">
                            <thead>
                                <tr>
                                    <th>商品编号</th>
                                    <th>名称</th>
                                    <th>金额</th>
                                    <th>创建日期</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody id="recentLinksTable">
                                <tr>
                                    <td colspan="4" class="text-center">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 最近交易 -->
                <div class="card">
                    <div class="card-header">
                        <h3>最近交易</h3>
                    </div>
                    <div class="card-body">
                        <table class="pure-table pure-table-bordered">
                            <thead>
                                <tr>
                                    <th>交易ID</th>
                                    <th>商品名称</th>
                                    <th>金额</th>
                                    <th>支付方式</th>
                                    <th>日期</th>
                                </tr>
                            </thead>
                            <tbody id="recentTransactionsTable">
                                <tr>
                                    <td colspan="4" class="text-center">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 在"最近交易"之后添加"产品目录"部分 -->
                <div class="card">
                    <div class="card-header">
                        <h3>产品目录</h3>
                        <button id="createProductBtn" class="pure-button primary-button">创建产品</button>
                    </div>
                    <div class="card-body">
                        <table class="pure-table pure-table-bordered">
                            <thead>
                                <tr>
                                    <th>图片</th>
                                    <th>商品名</th>
                                    <th>定价</th>
                                    <th>商品描述</th>
                                    <th>创建日期</th>
                                    <th>更新日期</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable">
                                <tr>
                                    <td colspan="6" class="text-center">暂无产品数据</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 在控制台页面添加创建链接模态框 -->
            <div id="createLinkModal" class="pure-modal">
                <div class="pure-modal-overlay" onclick="closeModal()"></div>
                <div class="pure-modal-container">
                    <div class="pure-modal-header">
                        <h4>创建支付链接</h4>
                        <button class="pure-modal-close" onclick="closeModal()">×</button>
                    </div>
                    <div class="pure-modal-body">
                        <form id="createLinkForm" class="pure-form pure-form-stacked">
                            <!-- 1. 商品信息 -->
                            <h5>商品信息</h5>
                            <hr>
                            
                            <div class="form-group">
                                <label for="selectProduct">选择商品</label>
                                <select id="selectProduct" class="form-control">
                                    <option value="">选择已有商品</option>
                                    <!-- 动态加载商品选项 -->
                                </select>
                            </div>
                            
                            <button type="button" class="pure-button secondary-button" id="addNewProductBtn">
                                <i class="icon-plus"></i> 新增商品
                            </button>
                            
                            <div id="productDetails" style="margin-top: 15px; display: none;">
                                <div class="form-group">
                                    <label for="title">商品名称 *</label>
                                    <input type="text" id="title" class="form-control" required maxlength="50">
                                </div>
                                
                                <div class="pure-g">
                                    <div class="pure-u-1-2">
                                        <div class="form-group">
                                            <label for="amount">价格 *</label>
                                            <input type="number" id="amount" class="form-control" step="0.01" min="0.01" required>
                                        </div>
                                    </div>
                                    <div class="pure-u-1-2">
                                        <div class="form-group">
                                            <label for="currency">币种 *</label>
                                            <select id="currency" class="form-control" required>
                                                <option value="USD">美元 (USD)</option>
                                                <option value="EUR">欧元 (EUR)</option>
                                                <option value="JPY">日元 (JPY)</option>
                                                <option value="CNY">人民币 (CNY)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="description">商品描述</label>
                                    <textarea id="description" class="form-control" rows="3" maxlength="200"></textarea>
                                    <small>最多200个字符，描述仅显示在商户管理界面，不会展示给客户。</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="image">商品图片</label>
                                    <input type="file" id="image" class="form-control" accept="image/png, image/jpeg">
                                    <small>支持JPG/PNG，最大2MB</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="priceNote">价格说明</label>
                                    <textarea id="priceNote" class="form-control" rows="2"></textarea>
                                    <small>价格说明仅显示给商户，不会展示给客户</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="productCode">商品编号 *</label>
                                    <input type="text" id="productCode" class="form-control" required maxlength="20">
                                    <small>输入唯一商品编号，不可重复</small>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 15px;">
                                <label class="pure-checkbox">
                                    <input type="checkbox" id="allowQuantityAdjustment"> 
                                    允许客户调整数量
                                </label>
                            </div>
                            
                            <!-- 2. 账单选项 -->
                            <h5 style="margin-top: 20px;">账单选项</h5>
                            <hr>
                            
                            <div class="form-group">
                                <label class="pure-checkbox">
                                    <input type="checkbox" id="collectAddress"> 
                                    收集客户地址
                                </label>
                                
                                <div id="addressTypeOptions" style="margin-left: 25px; margin-top: 10px; display: none;">
                                    <label class="pure-radio">
                                        <input type="radio" name="addressType" value="billing" checked> 
                                        仅账单地址
                                    </label>
                                    <br>
                                    <label class="pure-radio">
                                        <input type="radio" name="addressType" value="both"> 
                                        账单地址和配送地址
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="pure-checkbox">
                                    <input type="checkbox" id="requirePhone"> 
                                    要求用户提供手机号
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label>支付方式</label>
                                <div style="margin-top: 10px;">
                                    <label class="pure-checkbox">
                                        <input type="checkbox" id="cardPayment" checked> 
                                        卡支付
                                    </label>
                                    <br>
                                    <label class="pure-checkbox">
                                        <input type="checkbox" id="googlePay"> 
                                        Google Pay
                                    </label>
                                    <br>
                                    <label class="pure-checkbox">
                                        <input type="checkbox" id="applePay"> 
                                        Apple Pay
                                    </label>
                                </div>
                            </div>
                            
                            <!-- 3. 高级选项 -->
                            <h5 style="margin-top: 20px;">高级选项</h5>
                            <hr>
                            
                            <div class="form-group">
                                <button type="button" class="pure-button secondary-button" id="addCustomFieldBtn">
                                    <i class="icon-plus"></i> 添加自定义字段
                                </button>
                                
                                <div id="customFieldsContainer" style="margin-top: 10px;">
                                    <!-- 动态添加的自定义字段将在这里显示 -->
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="pure-checkbox">
                                    <input type="checkbox" id="usePromoCode"> 
                                    使用促销码
                                </label>
                            </div>
                            
                            <!-- 4. 支付后查看 -->
                            <h5 style="margin-top: 20px;">支付后查看</h5>
                            <hr>
                            
                            <div class="form-group">
                                <div>
                                    <label class="pure-radio">
                                        <input type="radio" name="postPaymentAction" value="showConfirmation" checked> 
                                        显示确认页面
                                    </label>
                                    
                                    <div id="confirmationMessageOptions" style="margin-left: 25px; margin-top: 10px;">
                                        <label class="pure-checkbox">
                                            <input type="checkbox" id="useCustomMessage"> 
                                            使用自定义消息
                                        </label>
                                        
                                        <div id="customMessageField" style="margin-top: 10px; display: none;">
                                            <textarea id="customMessage" class="form-control" rows="3" placeholder="输入支付成功后显示的自定义消息"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 15px;">
                                    <label class="pure-radio">
                                        <input type="radio" name="postPaymentAction" value="redirect"> 
                                        不显示确认页面，跳转到网站
                                    </label>
                                    
                                    <div id="redirectUrlField" style="margin-left: 25px; margin-top: 10px; display: none;">
                                        <label for="redirectUrl">跳转网址</label>
                                        <input type="url" id="redirectUrl" class="form-control" placeholder="https://example.com/thank-you">
                                    </div>
                                </div>
                            </div>

                            <!-- 在表单中添加或确认这些单选按钮存在 -->
                            <div class="form-group">
                                <label>金额类型</label>
                                <div>
                                    <label class="pure-radio">
                                        <input type="radio" name="amountType" value="FIXED" checked> 固定金额
                                    </label>
                                    <label class="pure-radio">
                                        <input type="radio" name="amountType" value="DYNAMIC"> 动态金额
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>有效期</label>
                                <div>
                                    <label class="pure-radio">
                                        <input type="radio" name="validityType" value="PERMANENT" checked> 永久有效
                                    </label>
                                    <label class="pure-radio">
                                        <input type="radio" name="validityType" value="FIXED"> 指定截止日期
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="pure-modal-footer">
                        <button type="button" class="pure-button secondary-button" onclick="closeModal()">取消</button>
                        <button type="button" class="pure-button primary-button" id="submitLinkForm">创建链接</button>
                    </div>
                </div>
            </div>

            <!-- 在页面底部添加手动付款模态框 -->
            <div id="manualPaymentModal" class="pure-modal">
                <div class="pure-modal-overlay" onclick="closeManualModal()"></div>
                <div class="pure-modal-container">
                    <div class="pure-modal-header">
                        <h4>手动付款</h4>
                        <button class="pure-modal-close" onclick="closeManualModal()">×</button>
                    </div>
                    <div class="pure-modal-body">
                        <form id="manualPaymentForm" class="pure-form pure-form-stacked">
                            <!-- 商品信息 -->
                            <h5>商品信息</h5>
                            <hr>
                            
                            <div class="form-group">
                                <label for="manual_title">商品名称 *</label>
                                <input type="text" id="manual_title" class="form-control" required maxlength="50">
                            </div>
                            
                            <div class="form-group">
                                <label for="manual_productCode">商品编号 *</label>
                                <input type="text" id="manual_productCode" class="form-control" required maxlength="20">
                                <small>输入唯一商品编号，不可重复</small>
                            </div>
                            
                            <div class="pure-g">
                                <div class="pure-u-1-2">
                                    <div class="form-group">
                                        <label for="manual_amount">金额 *</label>
                                        <input type="number" id="manual_amount" class="form-control" step="0.01" min="0.01" required>
                                    </div>
                                </div>
                                <div class="pure-u-1-2">
                                    <div class="form-group">
                                        <label for="manual_currency">货币 *</label>
                                        <select id="manual_currency" class="form-control" required>
                                            <option value="USD">美元 (USD)</option>
                                            <option value="EUR">欧元 (EUR)</option>
                                            <option value="JPY">日元 (JPY)</option>
                                            <option value="CNY">人民币 (CNY)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 客户信息 -->
                            <h5 style="margin-top: 20px;">客户信息</h5>
                            <hr>
                            
                            <div class="form-group">
                                <label for="customer_name">客户姓名 *</label>
                                <input type="text" id="customer_name" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="customer_email">客户邮箱</label>
                                <input type="email" id="customer_email" class="form-control">
                            </div>
                            
                            <!-- 卡片信息 -->
                            <h5 style="margin-top: 20px;">支付卡信息</h5>
                            <hr>
                            
                            <div class="form-group">
                                <label for="card_number">卡号 *</label>
                                <input type="text" id="card_number" class="form-control" required placeholder="XXXX XXXX XXXX XXXX">
                            </div>
                            
                            <div class="pure-g">
                                <div class="pure-u-1-2">
                                    <div class="form-group">
                                        <label for="card_expiry">有效期 *</label>
                                        <input type="text" id="card_expiry" class="form-control" required placeholder="MM/YY">
                                    </div>
                                </div>
                                <div class="pure-u-1-2">
                                    <div class="form-group">
                                        <label for="card_cvc">安全码 *</label>
                                        <input type="text" id="card_cvc" class="form-control" required placeholder="CVC">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="pure-modal-footer">
                        <button type="button" class="pure-button secondary-button" onclick="closeManualModal()">取消</button>
                        <button type="button" class="pure-button primary-button" id="submitManualPayment">处理付款</button>
                    </div>
                </div>
            </div>

            <!-- 在页面底部添加动态金额付款模态框 -->
            <div id="dynamicPaymentModal" class="pure-modal">
                <div class="pure-modal-overlay" onclick="closeDynamicModal()"></div>
                <div class="pure-modal-container">
                    <div class="pure-modal-header">
                        <h4>创建动态金额付款链接</h4>
                        <button class="pure-modal-close" onclick="closeDynamicModal()">×</button>
                    </div>
                    <div class="pure-modal-body">
                        <form id="dynamicPaymentForm" class="pure-form pure-form-stacked">
                            <!-- 基础信息 -->
                            <h5>基础信息</h5>
                            <hr>
                            
                            <div class="form-group">
                                <label for="dynamic_title">商品名称 *</label>
                                <input type="text" id="dynamic_title" class="form-control" required maxlength="50">
                                <small>最多50个字符</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="dynamic_description">商品描述</label>
                                <textarea id="dynamic_description" class="form-control" rows="3" maxlength="200"></textarea>
                                <small>最多200个字符，描述仅显示在商户管理界面</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="dynamic_productCode">商品编号 *</label>
                                <input type="text" id="dynamic_productCode" class="form-control" required maxlength="20">
                                <small>输入唯一商品编号，不可重复</small>
                            </div>
                            
                            <!-- 金额设置 -->
                            <h5 style="margin-top: 20px;">金额设置</h5>
                            <hr>
                            
                            <div class="pure-g">
                                <div class="pure-u-1-3">
                                    <div class="form-group">
                                        <label for="dynamic_minAmount">最小金额</label>
                                        <input type="number" id="dynamic_minAmount" class="form-control" step="0.01" min="0.01">
                                    </div>
                                </div>
                                <div class="pure-u-1-3">
                                    <div class="form-group">
                                        <label for="dynamic_maxAmount">最大金额</label>
                                        <input type="number" id="dynamic_maxAmount" class="form-control" step="0.01" min="0.01">
                                    </div>
                                </div>
                                <div class="pure-u-1-3">
                                    <div class="form-group">
                                        <label for="dynamic_currency">货币 *</label>
                                        <select id="dynamic_currency" class="form-control" required>
                                            <option value="USD">美元 (USD)</option>
                                            <option value="EUR">欧元 (EUR)</option>
                                            <option value="JPY">日元 (JPY)</option>
                                            <option value="CNY">人民币 (CNY)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 高级设置 -->
                            <h5 style="margin-top: 20px;">高级设置</h5>
                            <hr>
                            
                            <div class="form-group">
                                <label>有效期设置</label>
                                <div class="pure-g">
                                    <div class="pure-u-1-2">
                                        <label class="pure-radio">
                                            <input type="radio" name="dynamic_validityType" value="PERMANENT" checked> 永久有效
                                        </label>
                                    </div>
                                    <div class="pure-u-1-2">
                                        <label class="pure-radio">
                                            <input type="radio" name="dynamic_validityType" value="FIXED"> 设置有效期
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="dynamicValidityFields" style="display: none;">
                                <div class="pure-g">
                                    <div class="pure-u-1-2">
                                        <div class="form-group">
                                            <label for="dynamic_endDate">截止日期</label>
                                            <input type="date" id="dynamic_endDate" class="form-control">
                                        </div>
                                    </div>
                                    <div class="pure-u-1-2">
                                        <div class="form-group">
                                            <label for="dynamic_maxUsage">使用次数限制</label>
                                            <input type="number" id="dynamic_maxUsage" class="form-control" min="1" max="1000">
                                            <small>留空表示不限制次数</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>支付方式</label>
                                <div class="alert alert-info">
                                    默认支持所有可用的支付方式，包括信用卡支付、Apple Pay和本地支付方式。
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="pure-modal-footer">
                        <button type="button" class="pure-button secondary-button" onclick="closeDynamicModal()">取消</button>
                        <button type="button" class="pure-button primary-button" id="submitDynamicPayment">创建链接</button>
                    </div>
                </div>
            </div>

            <!-- 添加创建产品模态框 -->
            <div id="createProductModal" class="pure-modal">
                <div class="pure-modal-overlay" onclick="closeProductModal()"></div>
                <div class="pure-modal-container">
                    <div class="pure-modal-header">
                        <h4>创建产品</h4>
                        <button class="pure-modal-close" onclick="closeProductModal()">×</button>
                    </div>
                    <div class="pure-modal-body">
                        <form id="createProductForm" class="pure-form pure-form-stacked">
                            <!-- 基础信息 -->
                            <h5>基础信息</h5>
                            <hr>
                            
                            <div class="form-group">
                                <label for="productName">商品名称 *</label>
                                <input type="text" id="productName" class="form-control" required maxlength="50">
                                <small>最多50个字符</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="productDescription">商品描述</label>
                                <textarea id="productDescription" class="form-control" rows="3" maxlength="200"></textarea>
                                <small>最多200个字符，描述仅显示在商户管理界面</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="productImage">商品图片</label>
                                <input type="file" id="productImage" class="form-control" accept="image/png, image/jpeg">
                                <small>支持JPG/PNG，最大2MB</small>
                            </div>
                            
                            <!-- 价格设置 -->
                            <h5 style="margin-top: 20px;">价格设置 *</h5>
                            <hr>
                            
                            <div class="pure-g">
                                <div class="pure-u-1-2">
                                    <div class="form-group">
                                        <label for="productPrice">价格 *</label>
                                        <input type="number" id="productPrice" class="form-control" step="0.01" min="0.01" required>
                                    </div>
                                </div>
                                <div class="pure-u-1-2">
                                    <div class="form-group">
                                        <label for="productCurrency">货币 *</label>
                                        <select id="productCurrency" class="form-control" required>
                                            <option value="USD">美元 (USD)</option>
                                            <option value="EUR">欧元 (EUR)</option>
                                            <option value="JPY">日元 (JPY)</option>
                                            <option value="CNY">人民币 (CNY)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="pure-modal-footer">
                        <button type="button" class="pure-button secondary-button" onclick="closeProductModal()">取消</button>
                        <button type="button" class="pure-button primary-button" id="submitProductForm">创建产品</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        // 1. 确保这些函数在全局作用域内定义，并在DOM加载前
        function toggleDropdown() {
            const dropdownMenu = document.querySelector('.dropdown-menu');
            if (dropdownMenu) {
                dropdownMenu.classList.toggle('show');
            }
        }
        
        function showModal() {
            const modal = document.getElementById('createLinkModal');
            if (modal) {
                console.log('显示创建链接模态框');
                modal.style.display = 'block';
                document.body.classList.add('modal-open');
            } else {
                console.error('createLinkModal元素不存在');
            }
        }
        
        function closeModal() {
            const modal = document.getElementById('createLinkModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        }
        
        function showManualModal() {
            const modal = document.getElementById('manualPaymentModal');
            if (modal) {
                modal.style.display = 'block';
                document.body.classList.add('modal-open');
            }
        }
        
        function closeManualModal() {
            const modal = document.getElementById('manualPaymentModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        }
        
        function showDynamicModal() {
            const modal = document.getElementById('dynamicPaymentModal');
            if (modal) {
                modal.style.display = 'block';
                document.body.classList.add('modal-open');
            }
        }
        
        function closeDynamicModal() {
            const modal = document.getElementById('dynamicPaymentModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        }
        
        function showProductModal() {
            const modal = document.getElementById('createProductModal');
            if (modal) {
                modal.style.display = 'block';
                document.body.classList.add('modal-open');
            }
        }
        
        function closeProductModal() {
            const modal = document.getElementById('createProductModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        }
        
        // 安全设置文本内容的辅助函数
        function safeSetTextContent(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 2. 确保在DOM加载后绑定事件监听器
            const createLinkBtn = document.getElementById('createLinkBtn');
            if (createLinkBtn) {
                createLinkBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    toggleDropdown();
                });
            }
            
            const createPaymentLink = document.getElementById('createPaymentLink');
            if (createPaymentLink) {
                createPaymentLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const dropdownMenu = document.querySelector('.dropdown-menu');
                    if (dropdownMenu) {
                        dropdownMenu.classList.remove('show');
                    }
                    showModal();
                });
            }
            
            // 添加创建产品按钮事件监听
            const createProductBtn = document.getElementById('createProductBtn');
            if (createProductBtn) {
                createProductBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showProductModal();
                });
            }
            
            // 处理产品表单提交
            const submitProductForm = document.getElementById('submitProductForm');
            if (submitProductForm) {
                submitProductForm.addEventListener('click', function() {
                    const form = document.getElementById('createProductForm');
                    
                    // 验证表单
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }
                    
                    // 获取表单数据
                    const productName = document.getElementById('productName').value;
                    const productDescription = document.getElementById('productDescription').value;
                    const productPrice = parseFloat(document.getElementById('productPrice').value);
                    const productCurrency = document.getElementById('productCurrency').value;
                    
                    // 获取图片数据
                    let imageData = null;
                    const imageFile = document.getElementById('productImage').files[0];
                    if (imageFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            imageData = e.target.result;
                            saveProductWithImage(productName, productDescription, productPrice, productCurrency, imageData);
                        };
                        reader.readAsDataURL(imageFile);
                    } else {
                        saveProductWithImage(productName, productDescription, productPrice, productCurrency, null);
                    }
                });
            }
            
            // 加载产品列表
            loadProducts();

            // 添加自定义字段计数器
            let customFieldCount = 0;

            // 处理下拉菜单选择商品
            document.getElementById('selectProduct').addEventListener('change', function() {
                const selectedValue = this.value;
                const productDetails = document.getElementById('productDetails');
                
                if (selectedValue) {
                    // 如果选择了现有商品，加载商品详情并隐藏详情部分
                    const products = JSON.parse(localStorage.getItem('products') || '[]');
                    const selectedProduct = products.find(p => p.id === selectedValue);
                    
                    if (selectedProduct) {
                        // 填充表单字段
                        document.getElementById('title').value = selectedProduct.name;
                        document.getElementById('amount').value = selectedProduct.price;
                        document.getElementById('currency').value = selectedProduct.currency;
                        document.getElementById('description').value = selectedProduct.description || '';
                        // 无法设置图片文件输入值，但可以用隐藏字段存储图片URL
                        
                        // 显示商品详情区域为只读模式
                        productDetails.style.display = 'block';
                        // 可以选择禁用这些字段，因为它们应从现有商品填充
                    } else {
                        // 未找到商品
                        productDetails.style.display = 'none';
                    }
                } else {
                    // 如果未选择商品，清空并隐藏详情部分
                    productDetails.style.display = 'none';
                    document.getElementById('createLinkForm').reset();
                }
            });

            // 处理"新增商品"按钮
            document.getElementById('addNewProductBtn').addEventListener('click', function() {
                // 清空选择的商品
                document.getElementById('selectProduct').value = '';
                // 显示商品详情区域
                document.getElementById('productDetails').style.display = 'block';
            });

            // 处理收集地址复选框
            document.getElementById('collectAddress').addEventListener('change', function() {
                document.getElementById('addressTypeOptions').style.display = this.checked ? 'block' : 'none';
            });

            // 处理自定义消息复选框
            document.getElementById('useCustomMessage').addEventListener('change', function() {
                document.getElementById('customMessageField').style.display = this.checked ? 'block' : 'none';
            });

            // 处理支付后操作单选按钮
            document.querySelectorAll('input[name="postPaymentAction"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'showConfirmation') {
                        document.getElementById('confirmationMessageOptions').style.display = 'block';
                        document.getElementById('redirectUrlField').style.display = 'none';
                    } else if (this.value === 'redirect') {
                        document.getElementById('confirmationMessageOptions').style.display = 'none';
                        document.getElementById('redirectUrlField').style.display = 'block';
                    }
                });
            });

            // 处理添加自定义字段按钮
            document.getElementById('addCustomFieldBtn').addEventListener('click', function() {
                const customFieldsContainer = document.getElementById('customFieldsContainer');
                const fieldId = 'customField_' + customFieldCount++;
                
                const fieldHtml = `
                    <div class="custom-field" id="${fieldId}_container" style="margin-bottom: 15px; padding: 10px; border: 1px dashed #ccc; border-radius: 4px;">
                        <div class="form-group">
                            <label for="${fieldId}_label">字段标签 *</label>
                            <input type="text" id="${fieldId}_label" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="${fieldId}_placeholder">占位文本</label>
                            <input type="text" id="${fieldId}_placeholder" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="pure-checkbox">
                                <input type="checkbox" id="${fieldId}_required"> 
                                必填字段
                            </label>
                        </div>
                        <button type="button" class="pure-button danger-button" onclick="removeCustomField('${fieldId}_container')">
                            删除此字段
                        </button>
                    </div>
                `;
                
                customFieldsContainer.insertAdjacentHTML('beforeend', fieldHtml);
            });

            // 定义移除自定义字段的函数
            function removeCustomField(containerId) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.remove();
                }
            }

            // 修改完善的submitLinkForm处理函数
            document.getElementById('submitLinkForm').addEventListener('click', function() {
                try {
                    console.log("提交按钮被点击");
                    
                    // 验证表单
                    const form = document.getElementById('createLinkForm');
                    if (!form) {
                        console.error('找不到createLinkForm表单');
                        alert('表单元素丢失，请刷新页面重试');
                        return;
                    }
                    
                    // 基本表单验证
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }
                    
                    // 获取并验证关键表单字段
                    const title = safeGetValue('title');
                    const productCode = safeGetValue('productCode');
                    
                    if (!title) {
                        alert('请填写商品名称');
                        return;
                    }
                    
                    if (!productCode) {
                        alert('请填写商品编号');
                        return;
                    }
                    
                    // 检查商品编号唯一性
                    const links = getAllLinks();
                    if (links.some(link => link.productCode === productCode)) {
                        alert('商品编号已存在，请使用唯一的商品编号');
                        return;
                    }
                    
                    // 构建链接对象
                    const link = createLinkObjectFromForm();
                    
                    // 处理图片上传
                    const imageInput = document.getElementById('image');
                    if (imageInput && imageInput.files && imageInput.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            link.imageUrl = e.target.result;
                            finalizeLinkCreation(link);
                        };
                        reader.readAsDataURL(imageInput.files[0]);
                    } else {
                        finalizeLinkCreation(link);
                    }
                } catch (error) {
                    console.error('创建链接时出错:', error);
                    alert('创建链接时发生错误: ' + error.message);
                }
            });

            // 从表单创建链接对象
            function createLinkObjectFromForm() {
                const title = safeGetValue('title');
                const description = safeGetValue('description');
                const productCode = safeGetValue('productCode');
                
                // 获取金额类型（支持回退）
                const amountTypeRadio = document.querySelector('input[name="amountType"]:checked');
                const amountType = amountTypeRadio ? amountTypeRadio.value : 'FIXED';
                
                // 获取有效期类型（支持回退）
                const validityTypeRadio = document.querySelector('input[name="validityType"]:checked');
                const validityType = validityTypeRadio ? validityTypeRadio.value : 'PERMANENT';
                
                const link = {
                    title,
                    description,
                    productCode,
                    validity: {
                        type: validityType
                    }
                };
                
                // 处理金额信息
                if (amountType === 'FIXED') {
                    const amount = safeGetNumberValue('amount', 0.01);
                    const quantity = parseInt(safeGetValue('quantity', '1')) || 1;
                    const currency = safeGetValue('currency', 'USD');
                    
                    link.amount = {
                        type: 'FIXED',
                        value: amount,
                        quantity: quantity,
                        currency: currency,
                        totalValue: amount * quantity
                    };
                } else {
                    const minAmount = safeGetNumberValue('minAmount', 0.01);
                    const maxAmount = safeGetNumberValue('maxAmount', 9999.99);
                    const currency = safeGetValue('dynamicCurrency', safeGetValue('currency', 'USD'));
                    
                    link.amount = {
                        type: 'DYNAMIC',
                        currency: currency,
                        minValue: minAmount,
                        maxValue: maxAmount
                    };
                }
                
                // 处理有效期
                if (validityType === 'FIXED') {
                    link.validity.endTime = safeGetValue('endDate', 
                        new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0]);
                    
                    const maxUsage = safeGetValue('maxUsage', '');
                    link.validity.maxUsage = maxUsage ? parseInt(maxUsage) : null;
                }
                
                // 添加其他选项
                link.allowQuantityAdjustment = document.getElementById('allowQuantityAdjustment')?.checked || false;
                link.collectAddress = document.getElementById('collectAddress')?.checked || false;
                
                if (link.collectAddress) {
                    const addressTypeRadio = document.querySelector('input[name="addressType"]:checked');
                    link.addressType = addressTypeRadio ? addressTypeRadio.value : 'billing';
                }
                
                link.requirePhone = document.getElementById('requirePhone')?.checked || false;
                
                // 获取支付方式
                link.paymentMethods = [];
                if (document.getElementById('cardPayment')?.checked) link.paymentMethods.push('card');
                if (document.getElementById('googlePay')?.checked) link.paymentMethods.push('google_pay');
                if (document.getElementById('applePay')?.checked) link.paymentMethods.push('apple_pay');
                
                // 获取自定义字段
                link.customFields = [];
                document.querySelectorAll('.custom-field').forEach(field => {
                    const fieldId = field.id.replace('_container', '');
                    const labelElem = document.getElementById(`${fieldId}_label`);
                    
                    if (labelElem) {
                        link.customFields.push({
                            label: labelElem.value,
                            placeholder: document.getElementById(`${fieldId}_placeholder`)?.value || '',
                            required: document.getElementById(`${fieldId}_required`)?.checked || false
                        });
                    }
                });
                
                // 获取支付后行为
                const postPaymentActionRadio = document.querySelector('input[name="postPaymentAction"]:checked');
                link.postPaymentAction = postPaymentActionRadio ? postPaymentActionRadio.value : 'showConfirmation';
                
                if (link.postPaymentAction === 'showConfirmation' && 
                    document.getElementById('useCustomMessage')?.checked) {
                    link.customMessage = safeGetValue('customMessage');
                } else if (link.postPaymentAction === 'redirect') {
                    link.redirectUrl = safeGetValue('redirectUrl');
                }
                
                link.usePromoCode = document.getElementById('usePromoCode')?.checked || false;
                
                return link;
            }

            // 完成链接创建流程
            function finalizeLinkCreation(link) {
                try {
                    console.log('保存链接:', link);
                    
                    // 保存链接
                    const savedLink = saveLink(link);
                    console.log('链接保存成功:', savedLink);
                    
                    // 生成支付链接URL
                    const paymentUrl = `../customer/payment.html?id=${savedLink.shortId}`;
                    
                    // 关闭模态框
                    closeModal();
                    
                    // 显示成功消息并跳转
                    alert(`支付链接已创建成功！\n链接: ${paymentUrl}`);
                    window.location.href = 'manage-links.html';
                } catch (error) {
                    console.error('保存链接时发生错误:', error);
                    alert('创建链接失败: ' + (error.message || '未知错误'));
                }
            }
        });
        
        // 3. 添加错误处理和调试辅助
        window.addEventListener('error', function(e) {
            console.error('JavaScript错误:', e.message, 'at', e.filename, ':', e.lineno);
        });

        // 保存产品数据
        function saveProductWithImage(name, description, price, currency, imageUrl) {
            const product = {
                id: 'prod_' + Date.now() + Math.random().toString(36).substring(2, 10),
                name: name,
                description: description,
                price: price,
                currency: currency,
                imageUrl: imageUrl,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // 保存到localStorage
            let products = JSON.parse(localStorage.getItem('products') || '[]');
            products.push(product);
            localStorage.setItem('products', JSON.stringify(products));
            
            // 关闭模态框
            closeProductModal();
            
            // 重新加载产品列表
            loadProducts();
            
            // 重置表单
            document.getElementById('createProductForm').reset();
            
            // 显示成功消息
            alert('产品创建成功！');
        }

        // 加载产品列表
        function loadProducts() {
            const productsTable = document.getElementById('productsTable');
            if (!productsTable) return; // 安全检查
            
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            
            if (products.length === 0) {
                productsTable.innerHTML = '<tr><td colspan="6" class="text-center">暂无产品数据</td></tr>';
                return;
            }
            
            productsTable.innerHTML = '';
            
            products.forEach(product => {
                let imageCell = '<td class="text-center">无图片</td>';
                if (product.imageUrl) {
                    imageCell = `<td class="text-center"><img src="${product.imageUrl}" alt="${product.name}" style="max-width: 50px; max-height: 50px;"></td>`;
                }
                
                productsTable.innerHTML += `
                    <tr>
                        ${imageCell}
                        <td>${product.name}</td>
                        <td>${formatAmount(product.price, product.currency)}</td>
                        <td>${product.description || '无描述'}</td>
                        <td>${formatDate(product.createdAt)}</td>
                        <td>${formatDate(product.updatedAt)}</td>
                    </tr>
                `;
            });
        }

        // 获取表单字段的安全函数
        function safeGetValue(elementId, defaultValue = '') {
            const element = document.getElementById(elementId);
            return element ? element.value : defaultValue;
        }

        function safeGetNumberValue(elementId, defaultValue = 0) {
            const element = document.getElementById(elementId);
            return element ? parseFloat(element.value) || defaultValue : defaultValue;
        }
    </script>
</body>
</html>

