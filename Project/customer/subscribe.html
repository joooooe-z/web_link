<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢é˜… | Onerway</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-responsive-min.css">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/customer.css">
    <link rel="stylesheet" href="../css/subscription-customer.css">
</head>
<body>
    <div class="container">
        <div id="subscription-page" class="subscription-page">
            <div class="loader-container">
                <div class="loader"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <script src="../js/modules/subscription-core.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–é“¾æ¥ID
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            
            if (!id) {
                showError('é“¾æ¥ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ');
                return;
            }
            
            // è·å–é“¾æ¥ä¿¡æ¯
            const link = SubscriptionCore.getSubscriptionLinkByShortId(id);
            
            if (!link) {
                showError('é“¾æ¥ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ');
                return;
            }
            
            // è®°å½•è®¿é—®
            SubscriptionCore.recordSubscriptionLinkVisit(link.id);
            
            // æ¸²æŸ“è®¢é˜…é¡µé¢
            renderSubscriptionPage(link);
        });
        
        function showError(message) {
            const container = document.getElementById('subscription-page');
            container.innerHTML = `
                <div class="error-box">
                    <div class="error-icon">âš ï¸</div>
                    <h2>å‡ºé”™äº†</h2>
                    <p>${message}</p>
                    <a href="#" class="pure-button" onclick="window.close(); return false;">å…³é—­é¡µé¢</a>
                </div>
            `;
        }
        
        function renderSubscriptionPage(link) {
            if (link.status !== 'active') {
                showError('æ­¤è®¢é˜…é“¾æ¥å·²ç¦ç”¨');
                return;
            }
            
            const container = document.getElementById('subscription-page');
            
            // æ ¼å¼åŒ–é‡‘é¢
            const formattedAmount = new Intl.NumberFormat('zh-CN', { 
                style: 'currency', 
                currency: link.currency 
            }).format(link.amount);
            
            // è·å–æ‰£æ¬¾å‘¨æœŸæ–‡æœ¬
            let frequencyText;
            switch(link.billingFrequency) {
                case 'daily': frequencyText = 'æ¯å¤©'; break;
                case 'weekly': frequencyText = 'æ¯å‘¨'; break;
                case 'monthly': frequencyText = 'æ¯æœˆ'; break;
                default: frequencyText = link.billingFrequency;
            }
            
            // æœŸæ•°æ–‡æœ¬
            const cyclesText = link.totalBillingCycles === 'unlimited' ? 'æŒç»­è®¢é˜…' : `${link.totalBillingCycles}æœŸ`;
            
            container.innerHTML = `
                <div class="subscription-header">
                    <h1>è®¢é˜… ${link.title}</h1>
                </div>
                
                <div class="subscription-product">
                    ${link.imageUrl ? `<img src="${link.imageUrl}" alt="${link.title}" class="product-image">` : ''}
                    <div class="product-info">
                        <h2>${link.title}</h2>
                        <p>${link.description || ''}</p>
                        
                        <div class="pricing-details">
                            <div class="pricing-row">
                                <span>è®¢é˜…ä»·æ ¼</span>
                                <span>${formattedAmount}</span>
                            </div>
                            <div class="pricing-row">
                                <span>æ‰£æ¬¾å‘¨æœŸ</span>
                                <span>${frequencyText}</span>
                            </div>
                            <div class="pricing-row">
                                <span>è®¢é˜…æœŸæ•°</span>
                                <span>${cyclesText}</span>
                            </div>
                            ${link.trialDays > 0 ? `
                            <div class="pricing-row highlight">
                                <span>å…è´¹è¯•ç”¨</span>
                                <span>${link.trialDays}å¤©</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <form id="subscription-form" class="pure-form pure-form-stacked">
                    <fieldset>
                        <legend>æ‚¨çš„ä¿¡æ¯</legend>
                        
                        <div class="form-group">
                            <label for="email">ç”µå­é‚®ç®± *</label>
                            <input type="email" id="email" class="pure-input-1" required>
                        </div>
                        
                        ${link.requirePhone ? `
                        <div class="form-group">
                            <label for="phone">ç”µè¯å·ç  *</label>
                            <input type="tel" id="phone" class="pure-input-1" required>
                        </div>
                        ` : ''}
                        
                        ${link.addressCollection !== 'none' ? `
                        <div class="form-group">
                            <label for="address">è´¦å•åœ°å€ *</label>
                            <textarea id="address" class="pure-input-1" rows="3" required></textarea>
                        </div>
                        ` : ''}
                        
                        ${link.addressCollection === 'billing_and_shipping' ? `
                        <div class="form-group">
                            <label class="pure-checkbox">
                                <input type="checkbox" id="sameAsBilling" checked> 
                                é…é€åœ°å€ä¸è´¦å•åœ°å€ç›¸åŒ
                            </label>
                        </div>
                        
                        <div id="shipping-address-fields" style="display: none;">
                            <div class="form-group">
                                <label for="shippingAddress">é…é€åœ°å€ *</label>
                                <textarea id="shippingAddress" class="pure-input-1" rows="3"></textarea>
                            </div>
                        </div>
                        ` : ''}
                    </fieldset>
                    
                    <fieldset>
                        <legend>ä»˜æ¬¾æ–¹å¼</legend>
                        
                        <div class="payment-methods">
                            <div class="payment-method">
                                <input type="radio" name="paymentMethod" id="card-method" value="card" checked>
                                <label for="card-method">
                                    <span class="payment-icon">ğŸ’³</span>
                                    ä¿¡ç”¨å¡
                                </label>
                            </div>
                            
                            ${link.paymentMethods && link.paymentMethods.includes('google_pay') ? `
                            <div class="payment-method">
                                <input type="radio" name="paymentMethod" id="google-pay-method" value="google_pay">
                                <label for="google-pay-method">
                                    <span class="payment-icon">G</span>
                                    Google Pay
                                </label>
                            </div>
                            ` : ''}
                            
                            ${link.paymentMethods && link.paymentMethods.includes('apple_pay') ? `
                            <div class="payment-method">
                                <input type="radio" name="paymentMethod" id="apple-pay-method" value="apple_pay">
                                <label for="apple-pay-method">
                                    <span class="payment-icon">A</span>
                                    Apple Pay
                                </label>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div id="card-details" class="payment-details">
                            <div class="form-group">
                                <label for="cardNumber">å¡å· *</label>
                                <input type="text" id="cardNumber" class="pure-input-1" placeholder="1234 5678 9012 3456" required>
                            </div>
                            
                            <div class="pure-g">
                                <div class="pure-u-1-2">
                                    <div class="form-group">
                                        <label for="cardExpiry">æœ‰æ•ˆæœŸ *</label>
                                        <input type="text" id="cardExpiry" class="pure-input-1" placeholder="MM/YY" required>
                                    </div>
                                </div>
                                <div class="pure-u-1-2">
                                    <div class="form-group">
                                        <label for="cardCvc">å®‰å…¨ç  *</label>
                                        <input type="text" id="cardCvc" class="pure-input-1" placeholder="CVC" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    
                    <div class="terms-agreement">
                        <label class="pure-checkbox">
                            <input type="checkbox" id="terms-agreement" required> 
                            æˆ‘åŒæ„<a href="#" target="_blank">æœåŠ¡æ¡æ¬¾</a>å’Œ<a href="#" target="_blank">éšç§æ”¿ç­–</a>ï¼Œå¹¶æˆæƒæŒ‰ç…§ä¸Šè¿°è®¢é˜…è®¡åˆ’å®šæœŸä»˜æ¬¾ã€‚
                        </label>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="pure-button primary-button" id="submit-subscription">
                            å®Œæˆè®¢é˜…
                        </button>
                    </div>
                </form>
            `;
            
            // ç»‘å®šäº‹ä»¶
            if (link.addressCollection === 'billing_and_shipping') {
                document.getElementById('sameAsBilling').addEventListener('change', function() {
                    document.getElementById('shipping-address-fields').style.display = this.checked ? 'none' : 'block';
                    document.getElementById('shippingAddress').required = !this.checked;
                });
            }
            
            // æ”¯ä»˜æ–¹å¼åˆ‡æ¢
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    document.querySelectorAll('.payment-details').forEach(details => {
                        details.style.display = 'none';
                    });
                    
                    const methodType = radio.value;
                    if (methodType === 'card') {
                        document.getElementById('card-details').style.display = 'block';
                    }
                });
            });
            
            // è¡¨å•æäº¤
            document.getElementById('subscription-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // æ”¶é›†è¡¨å•æ•°æ®
                const formData = {
                    email: document.getElementById('email').value,
                    phone: link.requirePhone ? document.getElementById('phone').value : null,
                    address: link.addressCollection !== 'none' ? document.getElementById('address').value : null,
                    shippingAddress: link.addressCollection === 'billing_and_shipping' && !document.getElementById('sameAsBilling').checked 
                        ? document.getElementById('shippingAddress').value 
                        : null,
                    paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
                    cardDetails: document.querySelector('input[name="paymentMethod"]:checked').value === 'card' ? {
                        number: document.getElementById('cardNumber').value,
                        expiry: document.getElementById('cardExpiry').value,
                        cvc: document.getElementById('cardCvc').value
                    } : null
                };
                
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè¿›è¡Œæ”¯ä»˜å¤„ç†
                // æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ç®€å•æ¨¡æ‹ŸæˆåŠŸçš„è®¢é˜…æµç¨‹
                try {
                    // åˆ›å»ºè®¢é˜…å®ä¾‹
                    const instance = SubscriptionCore.createSubscriptionInstance(link.id, {
                        email: formData.email,
                        customerId: null, // åœ¨çœŸå®ç¯å¢ƒä¸­ï¼Œè¿™ä¼šæ˜¯ä¸€ä¸ªå®é™…çš„å®¢æˆ·ID
                        paymentMethod: formData.paymentMethod
                    });
                    
                    // å¦‚æœæœ‰å…è´¹è¯•ç”¨æœŸï¼Œä¸ä¼šç«‹å³åˆ›å»ºç¬¬ä¸€ç¬”äº¤æ˜“
                    if (!instance.trialEndsAt) {
                        // è®°å½•é¦–æ¬¡ä»˜æ¬¾
                        SubscriptionCore.recordSubscriptionTransaction(
                            instance.id,
                            instance.nextBillingAmount,
                            'succeeded'
                        );
                    }
                    
                    // æ˜¾ç¤ºæˆåŠŸé¡µé¢
                    showSuccessPage(instance, link);
                } catch (error) {
                    console.error('è®¢é˜…å¤±è´¥:', error);
                    showError('è®¢é˜…å¤„ç†å¤±è´¥: ' + error.message);
                }
            });
        }
        
        function showSuccessPage(instance, link) {
            const container = document.getElementById('subscription-page');
            
            // æ ¼å¼åŒ–é‡‘é¢
            const formattedAmount = new Intl.NumberFormat('zh-CN', { 
                style: 'currency', 
                currency: link.currency 
            }).format(link.amount);
            
            // è·å–ä¸‹æ¬¡æ‰£æ¬¾æ—¥æœŸ
            const nextBillingDate = new Date(instance.nextBillingDate).toLocaleDateString('zh-CN');
            
            container.innerHTML = `
                <div class="success-page">
                    <div class="success-icon">âœ“</div>
                    <h1>è®¢é˜…æˆåŠŸï¼</h1>
                    <p>æ„Ÿè°¢æ‚¨è®¢é˜… ${link.title}</p>
                    
                    <div class="subscription-details">
                        <h3>è®¢é˜…è¯¦æƒ…</h3>
                        <p>è®¢é˜…ID: ${instance.id}</p>
                        <p>äº§å“: ${link.title}</p>
                        <p>é‡‘é¢: ${formattedAmount}</p>
                        <p>æ‰£æ¬¾å‘¨æœŸ: ${instance.billingFrequency === 'daily' ? 'æ¯å¤©' : instance.billingFrequency === 'weekly' ? 'æ¯å‘¨' : 'æ¯æœˆ'}</p>
                        <p>ä¸‹æ¬¡æ‰£æ¬¾æ—¥æœŸ: ${nextBillingDate}</p>
                        ${instance.trialEndsAt ? `<p>è¯•ç”¨æœŸç»“æŸæ—¥æœŸ: ${new Date(instance.trialEndsAt).toLocaleDateString('zh-CN')}</p>` : ''}
                    </div>
                    
                    <p>è®¢é˜…ç¡®è®¤é‚®ä»¶å·²å‘é€è‡³æ‚¨çš„é‚®ç®± ${instance.customerEmail}</p>
                    
                    <button class="pure-button primary-button" onclick="window.close()">å…³é—­çª—å£</button>
                </div>
            `;
        }
    </script>
</body>
</html> 