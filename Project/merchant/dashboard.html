<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†æˆ·æ§åˆ¶å° | Onerway</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-responsive-min.css">
    <link rel="stylesheet" href="../css/lite-main.css">
</head>
<body>
    <div class="nav-container">
        <div class="container">
            <ul class="nav">
                <li class="nav-item"><a class="nav-link active" href="dashboard.html">æ§åˆ¶å°</a></li>
                <li class="nav-item"><a class="nav-link" href="manage-links.html">ç®¡ç†é“¾æ¥</a></li>
            </ul>
        </div>
    </div>

    <div class="container">
        <div class="header-actions">
            <h2>æ§åˆ¶å°</h2>
            <div class="dropdown">
                <button id="createLinkBtn" class="pure-button primary-button dropdown-toggle">
                    åˆ›å»ºæ–°é“¾æ¥ <span class="dropdown-arrow">â–¼</span>
                </button>
                <div class="dropdown-menu">
                    <a href="#" class="dropdown-item" id="createPaymentLink">æ”¯ä»˜é“¾æ¥</a>
                    <a href="#" class="dropdown-item" id="createManualPayment">æ‰‹åŠ¨ä»˜æ¬¾</a>
                    <a href="#" class="dropdown-item" id="createDynamicPayment">åŠ¨æ€é‡‘é¢ä»˜æ¬¾</a>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®æ¦‚è§ˆ -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <div class="stat-content">
                            <div class="stat-icon">ğŸ’°</div>
                            <div class="stat-info">
                                <h3 id="totalLinks">0</h3>
                                <p>æ´»è·ƒé“¾æ¥</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <div class="stat-content">
                            <div class="stat-icon">ğŸ‘ï¸</div>
                            <div class="stat-info">
                                <h3 id="totalVisits">0</h3>
                                <p>æ€»è®¿é—®</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <div class="stat-content">
                            <div class="stat-icon">âœ…</div>
                            <div class="stat-info">
                                <h3 id="totalConversions">0</h3>
                                <p>æˆåŠŸæ”¯ä»˜</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æœ€è¿‘é“¾æ¥ -->
        <div class="card">
            <div class="card-header">
                <h3>æœ€è¿‘é“¾æ¥</h3>
                <a href="manage-links.html" class="pure-button secondary-button">æŸ¥çœ‹å…¨éƒ¨</a>
            </div>
            <div class="card-body">
                <table class="pure-table pure-table-bordered">
                    <thead>
                        <tr>
                            <th>å•†å“ç¼–å·</th>
                            <th>åç§°</th>
                            <th>é‡‘é¢</th>
                            <th>åˆ›å»ºæ—¥æœŸ</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="recentLinksTable">
                        <tr>
                            <td colspan="4" class="text-center">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- æœ€è¿‘äº¤æ˜“ -->
        <div class="card">
            <div class="card-header">
                <h3>æœ€è¿‘äº¤æ˜“</h3>
            </div>
            <div class="card-body">
                <table class="pure-table pure-table-bordered">
                    <thead>
                        <tr>
                            <th>äº¤æ˜“ID</th>
                            <th>å•†å“åç§°</th>
                            <th>é‡‘é¢</th>
                            <th>æ”¯ä»˜æ–¹å¼</th>
                            <th>æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody id="recentTransactionsTable">
                        <tr>
                            <td colspan="4" class="text-center">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- åœ¨"æœ€è¿‘äº¤æ˜“"ä¹‹åæ·»åŠ "äº§å“ç›®å½•"éƒ¨åˆ† -->
        <div class="card">
            <div class="card-header">
                <h3>äº§å“ç›®å½•</h3>
                <button id="createProductBtn" class="pure-button primary-button">åˆ›å»ºäº§å“</button>
            </div>
            <div class="card-body">
                <table class="pure-table pure-table-bordered">
                    <thead>
                        <tr>
                            <th>å›¾ç‰‡</th>
                            <th>å•†å“å</th>
                            <th>å®šä»·</th>
                            <th>å•†å“æè¿°</th>
                            <th>åˆ›å»ºæ—¥æœŸ</th>
                            <th>æ›´æ–°æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <tr>
                            <td colspan="6" class="text-center">æš‚æ— äº§å“æ•°æ®</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- åœ¨æ§åˆ¶å°é¡µé¢æ·»åŠ åˆ›å»ºé“¾æ¥æ¨¡æ€æ¡† -->
    <div id="createLinkModal" class="pure-modal">
        <div class="pure-modal-overlay" onclick="closeModal()"></div>
        <div class="pure-modal-container">
            <div class="pure-modal-header">
                <h4>åˆ›å»ºæ”¯ä»˜é“¾æ¥</h4>
                <button class="pure-modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="pure-modal-body">
                <form id="createLinkForm" class="pure-form pure-form-stacked">
                    <!-- 1. å•†å“ä¿¡æ¯ -->
                    <h5>å•†å“ä¿¡æ¯</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label for="selectProduct">é€‰æ‹©å•†å“</label>
                        <select id="selectProduct" class="form-control">
                            <option value="">é€‰æ‹©å·²æœ‰å•†å“</option>
                            <!-- åŠ¨æ€åŠ è½½å•†å“é€‰é¡¹ -->
                        </select>
                    </div>
                    
                    <button type="button" class="pure-button secondary-button" id="addNewProductBtn">
                        <i class="icon-plus"></i> æ–°å¢å•†å“
                    </button>
                    
                    <div id="productDetails" style="margin-top: 15px; display: none;">
                        <div class="form-group">
                            <label for="title">å•†å“åç§° *</label>
                            <input type="text" id="title" class="form-control" required maxlength="50">
                        </div>
                        
                        <div class="pure-g">
                            <div class="pure-u-1-2">
                                <div class="form-group">
                                    <label for="amount">ä»·æ ¼ *</label>
                                    <input type="number" id="amount" class="form-control" step="0.01" min="0.01" required>
                                </div>
                            </div>
                            <div class="pure-u-1-2">
                                <div class="form-group">
                                    <label for="currency">å¸ç§ *</label>
                                    <select id="currency" class="form-control" required>
                                        <option value="USD">ç¾å…ƒ (USD)</option>
                                        <option value="EUR">æ¬§å…ƒ (EUR)</option>
                                        <option value="JPY">æ—¥å…ƒ (JPY)</option>
                                        <option value="CNY">äººæ°‘å¸ (CNY)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="description">å•†å“æè¿°</label>
                            <textarea id="description" class="form-control" rows="3" maxlength="200"></textarea>
                            <small>æœ€å¤š200ä¸ªå­—ç¬¦ï¼Œæè¿°ä»…æ˜¾ç¤ºåœ¨å•†æˆ·ç®¡ç†ç•Œé¢ï¼Œä¸ä¼šå±•ç¤ºç»™å®¢æˆ·ã€‚</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="image">å•†å“å›¾ç‰‡</label>
                            <input type="file" id="image" class="form-control" accept="image/png, image/jpeg">
                            <small>æ”¯æŒJPG/PNGï¼Œæœ€å¤§2MB</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="priceNote">ä»·æ ¼è¯´æ˜</label>
                            <textarea id="priceNote" class="form-control" rows="2"></textarea>
                            <small>ä»·æ ¼è¯´æ˜ä»…æ˜¾ç¤ºç»™å•†æˆ·ï¼Œä¸ä¼šå±•ç¤ºç»™å®¢æˆ·</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="productCode">å•†å“ç¼–å· *</label>
                            <input type="text" id="productCode" class="form-control" required maxlength="20">
                            <small>è¾“å…¥å”¯ä¸€å•†å“ç¼–å·ï¼Œä¸å¯é‡å¤</small>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label class="pure-checkbox">
                            <input type="checkbox" id="allowQuantityAdjustment"> 
                            å…è®¸å®¢æˆ·è°ƒæ•´æ•°é‡
                        </label>
                    </div>
                    
                    <!-- 2. è´¦å•é€‰é¡¹ -->
                    <h5 style="margin-top: 20px;">è´¦å•é€‰é¡¹</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label class="pure-checkbox">
                            <input type="checkbox" id="collectAddress"> 
                            æ”¶é›†å®¢æˆ·åœ°å€
                        </label>
                        
                        <div id="addressTypeOptions" style="margin-left: 25px; margin-top: 10px; display: none;">
                            <label class="pure-radio">
                                <input type="radio" name="addressType" value="billing" checked> 
                                ä»…è´¦å•åœ°å€
                            </label>
                            <br>
                            <label class="pure-radio">
                                <input type="radio" name="addressType" value="both"> 
                                è´¦å•åœ°å€å’Œé…é€åœ°å€
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="pure-checkbox">
                            <input type="checkbox" id="requirePhone"> 
                            è¦æ±‚ç”¨æˆ·æä¾›æ‰‹æœºå·
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>æ”¯ä»˜æ–¹å¼</label>
                        <div style="margin-top: 10px;">
                            <label class="pure-checkbox">
                                <input type="checkbox" id="cardPayment" checked> 
                                å¡æ”¯ä»˜
                            </label>
                            <br>
                            <label class="pure-checkbox">
                                <input type="checkbox" id="googlePay"> 
                                Google Pay
                            </label>
                            <br>
                            <label class="pure-checkbox">
                                <input type="checkbox" id="applePay"> 
                                Apple Pay
                            </label>
                        </div>
                    </div>
                    
                    <!-- 3. é«˜çº§é€‰é¡¹ -->
                    <h5 style="margin-top: 20px;">é«˜çº§é€‰é¡¹</h5>
                    <hr>
                    
                    <div class="form-group">
                        <button type="button" class="pure-button secondary-button" id="addCustomFieldBtn">
                            <i class="icon-plus"></i> æ·»åŠ è‡ªå®šä¹‰å­—æ®µ
                        </button>
                        
                        <div id="customFieldsContainer" style="margin-top: 10px;">
                            <!-- åŠ¨æ€æ·»åŠ çš„è‡ªå®šä¹‰å­—æ®µå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="pure-checkbox">
                            <input type="checkbox" id="usePromoCode"> 
                            ä½¿ç”¨ä¿ƒé”€ç 
                        </label>
                    </div>
                    
                    <!-- 4. æ”¯ä»˜åæŸ¥çœ‹ -->
                    <h5 style="margin-top: 20px;">æ”¯ä»˜åæŸ¥çœ‹</h5>
                    <hr>
                    
                    <div class="form-group">
                        <div>
                            <label class="pure-radio">
                                <input type="radio" name="postPaymentAction" value="showConfirmation" checked> 
                                æ˜¾ç¤ºç¡®è®¤é¡µé¢
                            </label>
                            
                            <div id="confirmationMessageOptions" style="margin-left: 25px; margin-top: 10px;">
                                <label class="pure-checkbox">
                                    <input type="checkbox" id="useCustomMessage"> 
                                    ä½¿ç”¨è‡ªå®šä¹‰æ¶ˆæ¯
                                </label>
                                
                                <div id="customMessageField" style="margin-top: 10px; display: none;">
                                    <textarea id="customMessage" class="form-control" rows="3" placeholder="è¾“å…¥æ”¯ä»˜æˆåŠŸåæ˜¾ç¤ºçš„è‡ªå®šä¹‰æ¶ˆæ¯"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <label class="pure-radio">
                                <input type="radio" name="postPaymentAction" value="redirect"> 
                                ä¸æ˜¾ç¤ºç¡®è®¤é¡µé¢ï¼Œè·³è½¬åˆ°ç½‘ç«™
                            </label>
                            
                            <div id="redirectUrlField" style="margin-left: 25px; margin-top: 10px; display: none;">
                                <label for="redirectUrl">è·³è½¬ç½‘å€</label>
                                <input type="url" id="redirectUrl" class="form-control" placeholder="https://example.com/thank-you">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="pure-modal-footer">
                <button type="button" class="pure-button secondary-button" onclick="closeModal()">å–æ¶ˆ</button>
                <button type="button" class="pure-button primary-button" id="submitLinkForm">åˆ›å»ºé“¾æ¥</button>
            </div>
        </div>
    </div>

    <!-- åœ¨é¡µé¢åº•éƒ¨æ·»åŠ æ‰‹åŠ¨ä»˜æ¬¾æ¨¡æ€æ¡† -->
    <div id="manualPaymentModal" class="pure-modal">
        <div class="pure-modal-overlay" onclick="closeManualModal()"></div>
        <div class="pure-modal-container">
            <div class="pure-modal-header">
                <h4>æ‰‹åŠ¨ä»˜æ¬¾</h4>
                <button class="pure-modal-close" onclick="closeManualModal()">Ã—</button>
            </div>
            <div class="pure-modal-body">
                <form id="manualPaymentForm" class="pure-form pure-form-stacked">
                    <!-- å•†å“ä¿¡æ¯ -->
                    <h5>å•†å“ä¿¡æ¯</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label for="manual_title">å•†å“åç§° *</label>
                        <input type="text" id="manual_title" class="form-control" required maxlength="50">
                    </div>
                    
                    <div class="form-group">
                        <label for="manual_productCode">å•†å“ç¼–å· *</label>
                        <input type="text" id="manual_productCode" class="form-control" required maxlength="20">
                        <small>è¾“å…¥å”¯ä¸€å•†å“ç¼–å·ï¼Œä¸å¯é‡å¤</small>
                    </div>
                    
                    <div class="pure-g">
                        <div class="pure-u-1-2">
                            <div class="form-group">
                                <label for="manual_amount">é‡‘é¢ *</label>
                                <input type="number" id="manual_amount" class="form-control" step="0.01" min="0.01" required>
                            </div>
                        </div>
                        <div class="pure-u-1-2">
                            <div class="form-group">
                                <label for="manual_currency">è´§å¸ *</label>
                                <select id="manual_currency" class="form-control" required>
                                    <option value="USD">ç¾å…ƒ (USD)</option>
                                    <option value="EUR">æ¬§å…ƒ (EUR)</option>
                                    <option value="JPY">æ—¥å…ƒ (JPY)</option>
                                    <option value="CNY">äººæ°‘å¸ (CNY)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å®¢æˆ·ä¿¡æ¯ -->
                    <h5 style="margin-top: 20px;">å®¢æˆ·ä¿¡æ¯</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label for="customer_name">å®¢æˆ·å§“å *</label>
                        <input type="text" id="customer_name" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer_email">å®¢æˆ·é‚®ç®±</label>
                        <input type="email" id="customer_email" class="form-control">
                    </div>
                    
                    <!-- å¡ç‰‡ä¿¡æ¯ -->
                    <h5 style="margin-top: 20px;">æ”¯ä»˜å¡ä¿¡æ¯</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label for="card_number">å¡å· *</label>
                        <input type="text" id="card_number" class="form-control" required placeholder="XXXX XXXX XXXX XXXX">
                    </div>
                    
                    <div class="pure-g">
                        <div class="pure-u-1-2">
                            <div class="form-group">
                                <label for="card_expiry">æœ‰æ•ˆæœŸ *</label>
                                <input type="text" id="card_expiry" class="form-control" required placeholder="MM/YY">
                            </div>
                        </div>
                        <div class="pure-u-1-2">
                            <div class="form-group">
                                <label for="card_cvc">å®‰å…¨ç  *</label>
                                <input type="text" id="card_cvc" class="form-control" required placeholder="CVC">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="pure-modal-footer">
                <button type="button" class="pure-button secondary-button" onclick="closeManualModal()">å–æ¶ˆ</button>
                <button type="button" class="pure-button primary-button" id="submitManualPayment">å¤„ç†ä»˜æ¬¾</button>
            </div>
        </div>
    </div>

    <!-- åœ¨é¡µé¢åº•éƒ¨æ·»åŠ åŠ¨æ€é‡‘é¢ä»˜æ¬¾æ¨¡æ€æ¡† -->
    <div id="dynamicPaymentModal" class="pure-modal">
        <div class="pure-modal-overlay" onclick="closeDynamicModal()"></div>
        <div class="pure-modal-container">
            <div class="pure-modal-header">
                <h4>åˆ›å»ºåŠ¨æ€é‡‘é¢ä»˜æ¬¾é“¾æ¥</h4>
                <button class="pure-modal-close" onclick="closeDynamicModal()">Ã—</button>
            </div>
            <div class="pure-modal-body">
                <form id="dynamicPaymentForm" class="pure-form pure-form-stacked">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <h5>åŸºç¡€ä¿¡æ¯</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label for="dynamic_title">å•†å“åç§° *</label>
                        <input type="text" id="dynamic_title" class="form-control" required maxlength="50">
                        <small>æœ€å¤š50ä¸ªå­—ç¬¦</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="dynamic_description">å•†å“æè¿°</label>
                        <textarea id="dynamic_description" class="form-control" rows="3" maxlength="200"></textarea>
                        <small>æœ€å¤š200ä¸ªå­—ç¬¦ï¼Œæè¿°ä»…æ˜¾ç¤ºåœ¨å•†æˆ·ç®¡ç†ç•Œé¢</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="dynamic_productCode">å•†å“ç¼–å· *</label>
                        <input type="text" id="dynamic_productCode" class="form-control" required maxlength="20">
                        <small>è¾“å…¥å”¯ä¸€å•†å“ç¼–å·ï¼Œä¸å¯é‡å¤</small>
                    </div>
                    
                    <!-- é‡‘é¢è®¾ç½® -->
                    <h5 style="margin-top: 20px;">é‡‘é¢è®¾ç½®</h5>
                    <hr>
                    
                    <div class="pure-g">
                        <div class="pure-u-1-3">
                            <div class="form-group">
                                <label for="dynamic_minAmount">æœ€å°é‡‘é¢</label>
                                <input type="number" id="dynamic_minAmount" class="form-control" step="0.01" min="0.01">
                            </div>
                        </div>
                        <div class="pure-u-1-3">
                            <div class="form-group">
                                <label for="dynamic_maxAmount">æœ€å¤§é‡‘é¢</label>
                                <input type="number" id="dynamic_maxAmount" class="form-control" step="0.01" min="0.01">
                            </div>
                        </div>
                        <div class="pure-u-1-3">
                            <div class="form-group">
                                <label for="dynamic_currency">è´§å¸ *</label>
                                <select id="dynamic_currency" class="form-control" required>
                                    <option value="USD">ç¾å…ƒ (USD)</option>
                                    <option value="EUR">æ¬§å…ƒ (EUR)</option>
                                    <option value="JPY">æ—¥å…ƒ (JPY)</option>
                                    <option value="CNY">äººæ°‘å¸ (CNY)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é«˜çº§è®¾ç½® -->
                    <h5 style="margin-top: 20px;">é«˜çº§è®¾ç½®</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label>æœ‰æ•ˆæœŸè®¾ç½®</label>
                        <div class="pure-g">
                            <div class="pure-u-1-2">
                                <label class="pure-radio">
                                    <input type="radio" name="dynamic_validityType" value="PERMANENT" checked> æ°¸ä¹…æœ‰æ•ˆ
                                </label>
                            </div>
                            <div class="pure-u-1-2">
                                <label class="pure-radio">
                                    <input type="radio" name="dynamic_validityType" value="FIXED"> è®¾ç½®æœ‰æ•ˆæœŸ
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="dynamicValidityFields" style="display: none;">
                        <div class="pure-g">
                            <div class="pure-u-1-2">
                                <div class="form-group">
                                    <label for="dynamic_endDate">æˆªæ­¢æ—¥æœŸ</label>
                                    <input type="date" id="dynamic_endDate" class="form-control">
                                </div>
                            </div>
                            <div class="pure-u-1-2">
                                <div class="form-group">
                                    <label for="dynamic_maxUsage">ä½¿ç”¨æ¬¡æ•°é™åˆ¶</label>
                                    <input type="number" id="dynamic_maxUsage" class="form-control" min="1" max="1000">
                                    <small>ç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶æ¬¡æ•°</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>æ”¯ä»˜æ–¹å¼</label>
                        <div class="alert alert-info">
                            é»˜è®¤æ”¯æŒæ‰€æœ‰å¯ç”¨çš„æ”¯ä»˜æ–¹å¼ï¼ŒåŒ…æ‹¬ä¿¡ç”¨å¡æ”¯ä»˜ã€Apple Payå’Œæœ¬åœ°æ”¯ä»˜æ–¹å¼ã€‚
                        </div>
                    </div>
                </form>
            </div>
            <div class="pure-modal-footer">
                <button type="button" class="pure-button secondary-button" onclick="closeDynamicModal()">å–æ¶ˆ</button>
                <button type="button" class="pure-button primary-button" id="submitDynamicPayment">åˆ›å»ºé“¾æ¥</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ åˆ›å»ºäº§å“æ¨¡æ€æ¡† -->
    <div id="createProductModal" class="pure-modal">
        <div class="pure-modal-overlay" onclick="closeProductModal()"></div>
        <div class="pure-modal-container">
            <div class="pure-modal-header">
                <h4>åˆ›å»ºäº§å“</h4>
                <button class="pure-modal-close" onclick="closeProductModal()">Ã—</button>
            </div>
            <div class="pure-modal-body">
                <form id="createProductForm" class="pure-form pure-form-stacked">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <h5>åŸºç¡€ä¿¡æ¯</h5>
                    <hr>
                    
                    <div class="form-group">
                        <label for="productName">å•†å“åç§° *</label>
                        <input type="text" id="productName" class="form-control" required maxlength="50">
                        <small>æœ€å¤š50ä¸ªå­—ç¬¦</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="productDescription">å•†å“æè¿°</label>
                        <textarea id="productDescription" class="form-control" rows="3" maxlength="200"></textarea>
                        <small>æœ€å¤š200ä¸ªå­—ç¬¦ï¼Œæè¿°ä»…æ˜¾ç¤ºåœ¨å•†æˆ·ç®¡ç†ç•Œé¢</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="productImage">å•†å“å›¾ç‰‡</label>
                        <input type="file" id="productImage" class="form-control" accept="image/png, image/jpeg">
                        <small>æ”¯æŒJPG/PNGï¼Œæœ€å¤§2MB</small>
                    </div>
                    
                    <!-- ä»·æ ¼è®¾ç½® -->
                    <h5 style="margin-top: 20px;">ä»·æ ¼è®¾ç½® *</h5>
                    <hr>
                    
                    <div class="pure-g">
                        <div class="pure-u-1-2">
                            <div class="form-group">
                                <label for="productPrice">ä»·æ ¼ *</label>
                                <input type="number" id="productPrice" class="form-control" step="0.01" min="0.01" required>
                            </div>
                        </div>
                        <div class="pure-u-1-2">
                            <div class="form-group">
                                <label for="productCurrency">è´§å¸ *</label>
                                <select id="productCurrency" class="form-control" required>
                                    <option value="USD">ç¾å…ƒ (USD)</option>
                                    <option value="EUR">æ¬§å…ƒ (EUR)</option>
                                    <option value="JPY">æ—¥å…ƒ (JPY)</option>
                                    <option value="CNY">äººæ°‘å¸ (CNY)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="pure-modal-footer">
                <button type="button" class="pure-button secondary-button" onclick="closeProductModal()">å–æ¶ˆ</button>
                <button type="button" class="pure-button primary-button" id="submitProductForm">åˆ›å»ºäº§å“</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
    <script src="../js/storage.js"></script>
    <script>
        // 1. ç¡®ä¿è¿™äº›å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸå†…å®šä¹‰ï¼Œå¹¶åœ¨DOMåŠ è½½å‰
        function toggleDropdown() {
            const dropdownMenu = document.querySelector('.dropdown-menu');
            if (dropdownMenu) {
                dropdownMenu.classList.toggle('show');
            }
        }
        
        function showModal() {
            const modal = document.getElementById('createLinkModal');
            if (modal) {
                modal.style.display = 'block';
                document.body.classList.add('modal-open');
            }
        }
        
        function closeModal() {
            const modal = document.getElementById('createLinkModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        }
        
        function showManualModal() {
            const modal = document.getElementById('manualPaymentModal');
            if (modal) {
                modal.style.display = 'block';
                document.body.classList.add('modal-open');
            }
        }
        
        function closeManualModal() {
            const modal = document.getElementById('manualPaymentModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        }
        
        function showDynamicModal() {
            const modal = document.getElementById('dynamicPaymentModal');
            if (modal) {
                modal.style.display = 'block';
                document.body.classList.add('modal-open');
            }
        }
        
        function closeDynamicModal() {
            const modal = document.getElementById('dynamicPaymentModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        }
        
        function showProductModal() {
            const modal = document.getElementById('createProductModal');
            if (modal) {
                modal.style.display = 'block';
                document.body.classList.add('modal-open');
            }
        }
        
        function closeProductModal() {
            const modal = document.getElementById('createProductModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        }
        
        // å®‰å…¨è®¾ç½®æ–‡æœ¬å†…å®¹çš„è¾…åŠ©å‡½æ•°
        function safeSetTextContent(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 2. ç¡®ä¿åœ¨DOMåŠ è½½åç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            const createLinkBtn = document.getElementById('createLinkBtn');
            if (createLinkBtn) {
                createLinkBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    toggleDropdown();
                });
            }
            
            const createPaymentLink = document.getElementById('createPaymentLink');
            if (createPaymentLink) {
                createPaymentLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const dropdownMenu = document.querySelector('.dropdown-menu');
                    if (dropdownMenu) {
                        dropdownMenu.classList.remove('show');
                    }
                    showModal();
                });
            }
            
            // æ·»åŠ åˆ›å»ºäº§å“æŒ‰é’®äº‹ä»¶ç›‘å¬
            const createProductBtn = document.getElementById('createProductBtn');
            if (createProductBtn) {
                createProductBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showProductModal();
                });
            }
            
            // å¤„ç†äº§å“è¡¨å•æäº¤
            const submitProductForm = document.getElementById('submitProductForm');
            if (submitProductForm) {
                submitProductForm.addEventListener('click', function() {
                    const form = document.getElementById('createProductForm');
                    
                    // éªŒè¯è¡¨å•
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }
                    
                    // è·å–è¡¨å•æ•°æ®
                    const productName = document.getElementById('productName').value;
                    const productDescription = document.getElementById('productDescription').value;
                    const productPrice = parseFloat(document.getElementById('productPrice').value);
                    const productCurrency = document.getElementById('productCurrency').value;
                    
                    // è·å–å›¾ç‰‡æ•°æ®
                    let imageData = null;
                    const imageFile = document.getElementById('productImage').files[0];
                    if (imageFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            imageData = e.target.result;
                            saveProductWithImage(productName, productDescription, productPrice, productCurrency, imageData);
                        };
                        reader.readAsDataURL(imageFile);
                    } else {
                        saveProductWithImage(productName, productDescription, productPrice, productCurrency, null);
                    }
                });
            }
            
            // åŠ è½½äº§å“åˆ—è¡¨
            loadProducts();

            // æ·»åŠ è‡ªå®šä¹‰å­—æ®µè®¡æ•°å™¨
            let customFieldCount = 0;

            // å¤„ç†ä¸‹æ‹‰èœå•é€‰æ‹©å•†å“
            document.getElementById('selectProduct').addEventListener('change', function() {
                const selectedValue = this.value;
                const productDetails = document.getElementById('productDetails');
                
                if (selectedValue) {
                    // å¦‚æœé€‰æ‹©äº†ç°æœ‰å•†å“ï¼ŒåŠ è½½å•†å“è¯¦æƒ…å¹¶éšè—è¯¦æƒ…éƒ¨åˆ†
                    const products = JSON.parse(localStorage.getItem('products') || '[]');
                    const selectedProduct = products.find(p => p.id === selectedValue);
                    
                    if (selectedProduct) {
                        // å¡«å……è¡¨å•å­—æ®µ
                        document.getElementById('title').value = selectedProduct.name;
                        document.getElementById('amount').value = selectedProduct.price;
                        document.getElementById('currency').value = selectedProduct.currency;
                        document.getElementById('description').value = selectedProduct.description || '';
                        // æ— æ³•è®¾ç½®å›¾ç‰‡æ–‡ä»¶è¾“å…¥å€¼ï¼Œä½†å¯ä»¥ç”¨éšè—å­—æ®µå­˜å‚¨å›¾ç‰‡URL
                        
                        // æ˜¾ç¤ºå•†å“è¯¦æƒ…åŒºåŸŸä¸ºåªè¯»æ¨¡å¼
                        productDetails.style.display = 'block';
                        // å¯ä»¥é€‰æ‹©ç¦ç”¨è¿™äº›å­—æ®µï¼Œå› ä¸ºå®ƒä»¬åº”ä»ç°æœ‰å•†å“å¡«å……
                    } else {
                        // æœªæ‰¾åˆ°å•†å“
                        productDetails.style.display = 'none';
                    }
                } else {
                    // å¦‚æœæœªé€‰æ‹©å•†å“ï¼Œæ¸…ç©ºå¹¶éšè—è¯¦æƒ…éƒ¨åˆ†
                    productDetails.style.display = 'none';
                    document.getElementById('createLinkForm').reset();
                }
            });

            // å¤„ç†"æ–°å¢å•†å“"æŒ‰é’®
            document.getElementById('addNewProductBtn').addEventListener('click', function() {
                // æ¸…ç©ºé€‰æ‹©çš„å•†å“
                document.getElementById('selectProduct').value = '';
                // æ˜¾ç¤ºå•†å“è¯¦æƒ…åŒºåŸŸ
                document.getElementById('productDetails').style.display = 'block';
            });

            // å¤„ç†æ”¶é›†åœ°å€å¤é€‰æ¡†
            document.getElementById('collectAddress').addEventListener('change', function() {
                document.getElementById('addressTypeOptions').style.display = this.checked ? 'block' : 'none';
            });

            // å¤„ç†è‡ªå®šä¹‰æ¶ˆæ¯å¤é€‰æ¡†
            document.getElementById('useCustomMessage').addEventListener('change', function() {
                document.getElementById('customMessageField').style.display = this.checked ? 'block' : 'none';
            });

            // å¤„ç†æ”¯ä»˜åæ“ä½œå•é€‰æŒ‰é’®
            document.querySelectorAll('input[name="postPaymentAction"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'showConfirmation') {
                        document.getElementById('confirmationMessageOptions').style.display = 'block';
                        document.getElementById('redirectUrlField').style.display = 'none';
                    } else if (this.value === 'redirect') {
                        document.getElementById('confirmationMessageOptions').style.display = 'none';
                        document.getElementById('redirectUrlField').style.display = 'block';
                    }
                });
            });

            // å¤„ç†æ·»åŠ è‡ªå®šä¹‰å­—æ®µæŒ‰é’®
            document.getElementById('addCustomFieldBtn').addEventListener('click', function() {
                const customFieldsContainer = document.getElementById('customFieldsContainer');
                const fieldId = 'customField_' + customFieldCount++;
                
                const fieldHtml = `
                    <div class="custom-field" id="${fieldId}_container" style="margin-bottom: 15px; padding: 10px; border: 1px dashed #ccc; border-radius: 4px;">
                        <div class="form-group">
                            <label for="${fieldId}_label">å­—æ®µæ ‡ç­¾ *</label>
                            <input type="text" id="${fieldId}_label" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="${fieldId}_placeholder">å ä½æ–‡æœ¬</label>
                            <input type="text" id="${fieldId}_placeholder" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="pure-checkbox">
                                <input type="checkbox" id="${fieldId}_required"> 
                                å¿…å¡«å­—æ®µ
                            </label>
                        </div>
                        <button type="button" class="pure-button danger-button" onclick="removeCustomField('${fieldId}_container')">
                            åˆ é™¤æ­¤å­—æ®µ
                        </button>
                    </div>
                `;
                
                customFieldsContainer.insertAdjacentHTML('beforeend', fieldHtml);
            });

            // å®šä¹‰ç§»é™¤è‡ªå®šä¹‰å­—æ®µçš„å‡½æ•°
            function removeCustomField(containerId) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.remove();
                }
            }

            // æ›¿æ¢submitLinkFormçš„äº‹ä»¶å¤„ç†å™¨ä»£ç 
            document.getElementById('submitLinkForm').addEventListener('click', function() {
                // éªŒè¯è¡¨å•
                const form = document.getElementById('createLinkForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                // è·å–è¡¨å•æ•°æ®
                const title = document.getElementById('title').value;
                const description = document.getElementById('description').value;
                const productCode = document.getElementById('productCode').value;
                const amountType = document.querySelector('input[name="amountType"]:checked') ? 
                                    document.querySelector('input[name="amountType"]:checked').value : 'FIXED';
                
                // æ£€æŸ¥å•†å“ç¼–å·å”¯ä¸€æ€§
                const links = getAllLinks();
                if (links.some(link => link.productCode === productCode)) {
                    alert('å•†å“ç¼–å·å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å”¯ä¸€çš„å•†å“ç¼–å·');
                    return;
                }
                
                // æ„å»ºé“¾æ¥å¯¹è±¡
                let link = {
                    title: title,
                    description: description,
                    productCode: productCode,
                    validity: {
                        type: document.querySelector('input[name="validityType"]:checked') ? 
                              document.querySelector('input[name="validityType"]:checked').value : 'PERMANENT'
                    }
                };
                
                // å¤„ç†é‡‘é¢ä¿¡æ¯
                if (amountType === 'FIXED') {
                    const amount = parseFloat(document.getElementById('amount').value);
                    const quantity = parseInt(document.getElementById('quantity').value) || 1;
                    const currency = document.getElementById('currency').value;
                    
                    link.amount = {
                        type: 'FIXED',
                        value: amount,
                        quantity: quantity,
                        currency: currency,
                        totalValue: amount * quantity
                    };
                } else {
                    const minAmount = parseFloat(document.getElementById('minAmount').value) || 0.01;
                    const maxAmount = parseFloat(document.getElementById('maxAmount').value) || 9999.99;
                    const currency = document.getElementById('dynamicCurrency') ? 
                                     document.getElementById('dynamicCurrency').value : 
                                     document.getElementById('currency').value;
                    
                    link.amount = {
                        type: 'DYNAMIC',
                        currency: currency,
                        minValue: minAmount,
                        maxValue: maxAmount
                    };
                }
                
                // å¤„ç†æœ‰æ•ˆæœŸ
                if (link.validity.type === 'FIXED') {
                    link.validity.endTime = document.getElementById('endDate') ? 
                                           document.getElementById('endDate').value : 
                                           new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0];
                    link.validity.maxUsage = document.getElementById('maxUsage') ? 
                                            parseInt(document.getElementById('maxUsage').value) || null : null;
                }
                
                // æ·»åŠ æ–°å¢çš„è¡¨å•å­—æ®µ
                link.allowQuantityAdjustment = document.getElementById('allowQuantityAdjustment').checked;
                link.collectAddress = document.getElementById('collectAddress').checked;
                link.addressType = link.collectAddress ? 
                                  document.querySelector('input[name="addressType"]:checked').value : null;
                link.requirePhone = document.getElementById('requirePhone').checked;
                
                // è·å–æ”¯ä»˜æ–¹å¼
                link.paymentMethods = [];
                if (document.getElementById('cardPayment').checked) link.paymentMethods.push('card');
                if (document.getElementById('googlePay').checked) link.paymentMethods.push('google_pay');
                if (document.getElementById('applePay').checked) link.paymentMethods.push('apple_pay');
                
                // è·å–è‡ªå®šä¹‰å­—æ®µ
                link.customFields = [];
                document.querySelectorAll('.custom-field').forEach(field => {
                    const fieldId = field.id.replace('_container', '');
                    const labelElem = document.getElementById(`${fieldId}_label`);
                    const placeholderElem = document.getElementById(`${fieldId}_placeholder`);
                    const requiredElem = document.getElementById(`${fieldId}_required`);
                    
                    if (labelElem) {
                        link.customFields.push({
                            label: labelElem.value,
                            placeholder: placeholderElem ? placeholderElem.value : '',
                            required: requiredElem ? requiredElem.checked : false
                        });
                    }
                });
                
                // è·å–æ”¯ä»˜åè¡Œä¸º
                const postPaymentActionElem = document.querySelector('input[name="postPaymentAction"]:checked');
                link.postPaymentAction = postPaymentActionElem ? postPaymentActionElem.value : 'showConfirmation';
                
                if (link.postPaymentAction === 'showConfirmation' && 
                    document.getElementById('useCustomMessage') && 
                    document.getElementById('useCustomMessage').checked) {
                    link.customMessage = document.getElementById('customMessage').value;
                } else if (link.postPaymentAction === 'redirect' && document.getElementById('redirectUrl')) {
                    link.redirectUrl = document.getElementById('redirectUrl').value;
                }
                
                link.usePromoCode = document.getElementById('usePromoCode') ? 
                                    document.getElementById('usePromoCode').checked : false;
                
                // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
                const imageFile = document.getElementById('image') ? document.getElementById('image').files[0] : null;
                if (imageFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        link.imageUrl = e.target.result;
                        saveAndCompleteProcess(link);
                    };
                    reader.readAsDataURL(imageFile);
                } else {
                    saveAndCompleteProcess(link);
                }
                
                function saveAndCompleteProcess(linkObj) {
                    try {
                        // ä¿å­˜é“¾æ¥
                        console.log('æ­£åœ¨ä¿å­˜é“¾æ¥:', linkObj);
                        const savedLink = saveLink(linkObj);
                        console.log('é“¾æ¥ä¿å­˜æˆåŠŸ:', savedLink);
                        
                        // ç”Ÿæˆæ”¯ä»˜é“¾æ¥URL
                        const paymentUrl = `../customer/payment.html?id=${savedLink.shortId}`;
                        
                        // å…³é—­æ¨¡æ€æ¡†
                        closeModal();
                        
                        // æ˜¾ç¤ºæˆåŠŸæç¤ºå¹¶è·³è½¬
                        alert(`æ”¯ä»˜é“¾æ¥å·²åˆ›å»ºæˆåŠŸï¼\né“¾æ¥: ${paymentUrl}`);
                        window.location.href = 'manage-links.html';
                    } catch (error) {
                        console.error('ä¿å­˜é“¾æ¥æ—¶å‡ºé”™:', error);
                        alert('åˆ›å»ºé“¾æ¥å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                }
            });
        });
        
        // 3. æ·»åŠ é”™è¯¯å¤„ç†å’Œè°ƒè¯•è¾…åŠ©
        window.addEventListener('error', function(e) {
            console.error('JavaScripté”™è¯¯:', e.message, 'at', e.filename, ':', e.lineno);
        });

        // ä¿å­˜äº§å“æ•°æ®
        function saveProductWithImage(name, description, price, currency, imageUrl) {
            const product = {
                id: 'prod_' + Date.now() + Math.random().toString(36).substring(2, 10),
                name: name,
                description: description,
                price: price,
                currency: currency,
                imageUrl: imageUrl,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // ä¿å­˜åˆ°localStorage
            let products = JSON.parse(localStorage.getItem('products') || '[]');
            products.push(product);
            localStorage.setItem('products', JSON.stringify(products));
            
            // å…³é—­æ¨¡æ€æ¡†
            closeProductModal();
            
            // é‡æ–°åŠ è½½äº§å“åˆ—è¡¨
            loadProducts();
            
            // é‡ç½®è¡¨å•
            document.getElementById('createProductForm').reset();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert('äº§å“åˆ›å»ºæˆåŠŸï¼');
        }

        // åŠ è½½äº§å“åˆ—è¡¨
        function loadProducts() {
            const productsTable = document.getElementById('productsTable');
            if (!productsTable) return; // å®‰å…¨æ£€æŸ¥
            
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            
            if (products.length === 0) {
                productsTable.innerHTML = '<tr><td colspan="6" class="text-center">æš‚æ— äº§å“æ•°æ®</td></tr>';
                return;
            }
            
            productsTable.innerHTML = '';
            
            products.forEach(product => {
                let imageCell = '<td class="text-center">æ— å›¾ç‰‡</td>';
                if (product.imageUrl) {
                    imageCell = `<td class="text-center"><img src="${product.imageUrl}" alt="${product.name}" style="max-width: 50px; max-height: 50px;"></td>`;
                }
                
                productsTable.innerHTML += `
                    <tr>
                        ${imageCell}
                        <td>${product.name}</td>
                        <td>${formatAmount(product.price, product.currency)}</td>
                        <td>${product.description || 'æ— æè¿°'}</td>
                        <td>${formatDate(product.createdAt)}</td>
                        <td>${formatDate(product.updatedAt)}</td>
                    </tr>
                `;
            });
        }
    </script>
</body>
</html>

