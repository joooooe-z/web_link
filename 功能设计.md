# Onerway Payment Link 功能设计文档

## 文档信息

| 文档属性 | 内容 |
|---------|------|
| 文档名称 | Onerway Payment Link 功能设计 |
| 版本号   | v1.0 |
| 创建日期 | 2023-06-01 |
| 状态     | 初稿 |
| 作者     | 技术架构团队 |
| 文档级别 | 内部技术文档 |

## 一、产品概述

### 1.1 产品定义

Onerway Payment Link是一项允许商户快速创建可分享的支付链接的功能，商户可通过简单操作生成链接并分享给客户，客户点击链接后即可完成支付，无需商户开发网站或应用程序。该功能基于Onerway现有的收银台系统，整合了多种支付方式和安全机制。

### 1.2 业务目标

1. 为中小型商户和个人卖家提供简单易用的收款工具
2. 扩展Onerway支付场景，满足临时收款、社交媒体销售等需求
3. 提升平台交易量和用户粘性
4. 增强与Stripe等主流支付平台的竞争力

### 1.3 目标用户

- 无技术团队的中小型在线商户
- 个人卖家和自由职业者
- 线下临时收款需求的实体商户
- 社交媒体销售者

## 二、功能架构

### 2.1 整体架构
+------------------------+ +------------------------+
| 商户管理系统 | | 客户支付流程 |
| | | |
| +-----------------+ | | +-----------------+ |
| | 链接创建与管理 | | | | 链接访问页面 | |
| +-----------------+ | | +-----------------+ |
| | | | |
| +-----------------+ | | v |
| | 数据分析与报表 | | | +-----------------+ |
| +-----------------+ | | | 支付流程 | |
| | | +-----------------+ |
+------------------------+ | | |
| | v |
v | +-----------------+ |
+------------------------+ | | 支付结果页面 | |
| 支付链接系统 | | +-----------------+ |
| | | |
| +-----------------+ | +------------------------+
| | 链接生成与存储 | | |
| +-----------------+ | |
| | | |
| v | v
| +-----------------+ | +------------------------+
| | 访问控制与安全 |---+---->| 支付处理系统 |
| +-----------------+ | | |
| | | +-----------------+ |
| +-----------------+ | | | 订单处理 | |
| | 数据统计 | | | +-----------------+ |
| +-----------------+ | | |
+------------------------+ +------------------------+



### 2.2 功能模块划分

1. **商户管理模块**
   - 链接创建功能
   - 链接管理功能
   - 数据分析功能

2. **支付链接系统**
   - 链接生成服务
   - 访问控制服务
   - 数据统计服务

3. **客户支付模块**
   - 链接访问页面
   - 支付流程
   - 结果反馈

4. **支付处理系统**
   - 订单处理服务
   - 支付方式适配
   - 通知服务

## 三、详细功能规格

### 3.1 商户管理模块

#### 3.1.1 链接创建功能

##### 基础信息配置
- **商品信息设置**
  - 商品名称：必填，最多50个字符
  - 商品描述：选填，最多200个字符
  - 商品图片：选填，支持JPG/PNG格式，最大2MB，建议尺寸800x600px

- **金额配置**
  - 固定金额模式：设置特定金额
  - 动态金额模式：允许客户在指定范围内输入金额
  - 多货币支持：USD/EUR/JPY/KRW等15种货币

##### 高级设置
- **有效期设置**
  - 永久有效
  - 自定义有效期：1小时至90天
  - 使用次数限制：单次/多次(1-1000次)/不限

- **支付结果页面**
  - 默认成功/失败页面
  - 自定义跳转URL

- **通知设置**
  - 邮件通知：支付成功/失败时通知商户
  - SMS通知：可选项，需额外配置
  - Webhook通知：支持自定义回调URL

##### 支付方式配置
- 信用卡支付：默认开启
- 电子钱包：Apple Pay/Google Pay等
- 本地支付方式：DANA/Kakao Pay/Touch 'n Go等
- 支付方式管理：可启用/禁用特定支付方式

#### 3.1.2 链接管理功能

##### 链接列表视图
- 分页显示：每页20条记录
- 列表字段：链接名称、金额、创建时间、状态、访问量、转化数
- 排序功能：按创建时间/使用次数/交易金额排序
- 筛选功能：按状态/时间段/金额范围筛选
- 搜索功能：支持按名称/ID模糊搜索

##### 链接详情视图
- 基础信息：创建时间、状态、累计交易额、访问次数等
- 数据可视化：访问与转化趋势图（24小时/7天/30天）
- 交易记录：该链接下所有交易的列表
- 操作功能：
  - 编辑链接：可修改描述/图片/有效期等非关键信息
  - 禁用/启用链接
  - 删除链接（需二次确认）

##### 分享工具
- 复制链接按钮
- 二维码生成（可下载）
- 一键分享到社交媒体（微信/Facebook/Twitter等）
- 嵌入代码生成（用于网站嵌入）

##### 数据导出功能
- 导出格式：CSV/Excel
- 导出范围：单个链接/批量链接
- 导出内容：自定义选择字段
- 定时导出：支持设置定期自动导出到指定邮箱

#### 3.1.3 数据分析功能

##### 总览面板
- 关键指标：总访问量、转化率、总交易额、平均订单金额
- 趋势图表：日/周/月交易趋势
- 支付方式分布：各支付方式使用比例饼图

##### 详细分析
- 时间分析：不同时段的交易表现
- 地域分析：访问者地理分布
- 设备分析：桌面端/移动端比例
- 来源分析：访问来源统计

##### 自定义报表
- 报表模板：预设多种报表模板
- 自定义时间段
- 多维度交叉分析
- 报表保存与分享

### 3.2 客户支付模块

#### 3.2.1 链接访问页面

##### 商品信息展示
- 商户Logo/名称展示
- 商品名称与描述信息
- 商品图片（如已上传）
- 金额显示（固定金额或输入框）

##### 自定义金额输入（动态金额模式）
- 金额输入框
- 预设金额快捷按钮（如适用）
- 金额范围提示
- 货币符号与单位显示

##### 操作按钮
- 主支付按钮：突出显示，文案为"立即支付"或"支付{金额}"
- 支付方式快捷选项：显示主要支付方式图标

#### 3.2.2 支付流程页面

##### 支付方式选择
- 继承Onerway现有收银台UI风格
- 按链接预设过滤可用的支付方式
- 支付方式分类展示：信用卡/电子钱包/本地支付

##### 信息采集表单
- 保持简洁的账单信息采集
- 根据支付方式动态调整必填项
- 表单验证与错误提示

##### 支付处理
- 显示处理状态
- 加载动画
- 超时处理机制

#### 3.2.3 支付结果页面

##### 成功页面
- 成功提示与图标
- 交易摘要信息
- 交易凭证/收据生成
- 返回商户/继续购物按钮

##### 失败页面
- 失败提示与原因说明
- 重试支付选项
- 联系客服选项
- 返回按钮

### 3.3 后端系统功能

#### 3.3.1 链接管理系统

##### 链接生成服务
- 唯一ID生成：安全随机算法
- 短链接格式：pay.onerway.com/p/{8位字母数字}
- 链接参数加密存储
- 有效期与使用限制管理

##### 访问控制服务
- 链接有效性验证
- 访问频率限制
- IP地址过滤
- 地区访问控制（可选）
- 防盗链措施

##### 数据统计服务
- 访问统计
- 转化率统计
- 支付方式统计
- 用户行为分析

#### 3.3.2 支付处理系统

##### 订单处理服务
- 从链接参数生成订单
- 金额验证
- 库存检查（如适用）
- 订单状态管理

##### 支付方式适配
- 支付方式路由
- 多支付渠道整合
- 支付结果处理

##### 通知服务
- 商户通知
- 客户通知
- Webhook回调
- 系统内部事件通知

## 四、用户流程

### 4.1 商户创建链接流程
+-----------------+ +------------------+ +------------------+
| 商户登录后台 |---->| 选择"创建链接" |---->| 填写基础信息 |
+-----------------+ +------------------+ +------------------+
|
v
+------------------+ +------------------+ +------------------+
| 获取链接并分享 |<----| 预览并确认 |<----| 配置高级选项 |
+------------------+ +------------------+ +------------------+

1. 商户登录管理后台
2. 点击"创建支付链接"按钮
3. 填写商品名称、描述、上传图片
4. 设置金额和货币类型
5. 配置高级选项（有效期、使用限制等）
6. 选择启用的支付方式
7. 预览链接效果
8. 确认创建获取链接URL和二维码
9. 通过所需渠道分享链接

### 4.2 客户支付流程
+------------------+ +------------------+ +------------------+
| 客户访问链接 |---->| 查看商品信息 |---->| 点击支付按钮 |
+------------------+ +------------------+ +------------------+
|
v
+------------------+ +------------------+ +------------------+
| 查看支付结果 |<----| 完成支付 |<----| 选择支付方式 |
+------------------+ +------------------+ | 并填写信息 |
+------------------+

1. 客户通过链接或扫描二维码访问支付页面
2. 查看商品信息和金额
3. 如是动态金额模式，则输入支付金额
4. 点击"支付"按钮
5. 进入Onerway收银台页面
6. 选择支付方式
7. 填写必要的支付信息
8. 确认并完成支付
9. 查看支付结果
10. 获取交易凭证（如需）

### 4.3 商户管理链接流程
+-----------------+ +------------------+ +------------------+
| 商户登录后台 |---->| 进入"链接管理" |---->| 查看链接列表 |
+-----------------+ +------------------+ +------------------+
|
v
+------------------+ +------------------+ +------------------+
| 执行操作 |<----| 查看链接详情 |<----| 选择特定链接 |
| (编辑/禁用/删除) | | 和数据分析 | | |
+------------------+ +------------------+ +------------------+

1. 商户登录管理后台
2. 进入"链接管理"页面
3. 浏览链接列表，使用筛选/排序/搜索功能
4. 选择特定链接查看详情
5. 分析链接性能数据
6. 查看关联的交易记录
7. 执行操作：编辑、禁用/启用、删除链接
8. 导出数据（如需）

## 五、技术实现规格

### 5.1 前端实现

#### 5.1.1 商户管理界面
- **技术栈**：React.js + Redux + Ant Design Pro
- **主要页面**：
  - 链接创建页：表单组件，多步骤向导
  - 链接管理页：表格组件，支持分页/排序/筛选
  - 链接详情页：数据展示组件，Echarts图表
  - 数据分析页：Dashboard布局，多图表组合

#### 5.1.2 客户支付页面
- **技术栈**：Vue.js + 响应式CSS
- **主要页面**：
  - 商品展示页：适配移动端与桌面端
  - 支付流程页：继承现有收银台组件
  - 结果页：状态展示与后续操作组件

### 5.2 后端实现

#### 5.2.1 API设计

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/v1/payment-links` | GET | 获取链接列表 |
| `/api/v1/payment-links` | POST | 创建新链接 |
| `/api/v1/payment-links/{id}` | GET | 获取单个链接详情 |
| `/api/v1/payment-links/{id}` | PUT | 更新链接信息 |
| `/api/v1/payment-links/{id}` | DELETE | 删除链接 |
| `/api/v1/payment-links/{id}/status` | PATCH | 更新链接状态 |
| `/api/v1/payment-links/{id}/statistics` | GET | 获取链接统计数据 |
| `/api/v1/payment-links/{id}/transactions` | GET | 获取链接交易记录 |
| `/api/v1/payment-links/{id}/qrcode` | GET | 获取链接二维码 |
| `/p/{short_id}` | GET | 链接访问入口 |
| `/api/v1/transactions` | POST | 创建交易 |
| `/api/v1/transactions/{id}/status` | GET | 获取交易状态 |

#### 5.2.2 数据模型

**PaymentLink模型:**
json
{
"id": "String", // 唯一标识
"merchantId": "String", // 商户ID
"shortId": "String", // 短链接ID
"title": "String", // 商品名称
"description": "String", // 商品描述
"imageUrl": "String", // 商品图片URL
"amount": { // 金额配置
"type": "FIXED/DYNAMIC", // 固定/动态
"value": "Number", // 固定金额值
"minValue": "Number", // 最小金额(动态)
"maxValue": "Number", // 最大金额(动态)
"currency": "String" // 货币代码
},
"validity": { // 有效期配置
"type": "PERMANENT/FIXED", // 永久/固定
"endTime": "DateTime", // 截止时间
"maxUsage": "Number" // 最大使用次数
},
"paymentMethods": ["String"], // 支持的支付方式
"customPages": { // 自定义页面
"success": "String", // 成功页URL
"failure": "String" // 失败页URL
},
"notifications": { // 通知配置
"email": "Boolean",
"sms": "Boolean",
"webhook": "String" // Webhook URL
},
"status": "ACTIVE/DISABLED/EXPIRED",
"stats": { // 实时统计
"visits": "Number", // 访问次数
"conversions": "Number", // 成交次数
"totalAmount": "Number" // 总成交金额
},
"createdAt": "DateTime",
"updatedAt": "DateTime"
}

**Transaction模型:**
json
{
  "id": "String",                  // 交易ID
  "linkId": "String",              // 关联链接ID
  "merchantId": "String",          // 商户ID
  "amount": "Number",              // 交易金额
  "currency": "String",            // 货币代码
  "paymentMethod": "String",       // 支付方式
  "status": "String",              // 交易状态
  "customerInfo": {                // 客户信息
    "email": "String",
    "name": "String",
    "phone": "String"
  },
  "metadata": "Object",            // 自定义元数据
  "createdAt": "DateTime",
  "updatedAt": "DateTime"
}

### 5.3 系统架构

#### 5.3.1 微服务架构
- **链接服务**：负责链接的CRUD操作
- **支付适配服务**：对接现有支付系统
- **统计分析服务**：处理数据统计与报表
- **通知服务**：处理各类通知

#### 5.3.2 数据存储
- **链接数据**：MongoDB（灵活schema）
- **交易记录**：MySQL（关系型数据）
- **访问日志**：Elasticsearch（搜索与分析）
- **缓存层**：Redis（高性能读取）

#### 5.3.3 安全架构
- API网关：请求验证与限流
- 身份认证：OAuth 2.0 + JWT
- 数据加密：传输加密 + 敏感数据存储加密
- 风控系统：交易监控与异常检测

## 六、实施计划

### 6.1 分阶段开发计划

#### 阶段一：基础功能（6周）
- 链接创建与管理功能
- 基础客户支付流程
- 核心API开发
- 数据存储实现

#### 阶段二：增强功能（4周）
- 数据分析与报表
- 高级链接设置
- 分享工具与集成
- 性能优化

#### 阶段三：完善与优化（3周）
- 安全增强
- 界面优化
- 多语言支持
- 全面测试与修复

### 6.2 里程碑与交付物

| 里程碑 | 时间点 | 交付物 |
|--------|--------|--------|
| 需求确认 | 第1周 | 需求规格文档 |
| 设计完成 | 第2周 | UI设计稿、技术设计文档 |
| 基础功能开发 | 第7周 | MVP版本 |
| 增强功能开发 | 第11周 | Beta版本 |
| 全面测试 | 第13周 | 测试报告 |
| 正式发布 | 第14周 | 1.0正式版 |

### 6.3 测试策略

- **单元测试**：覆盖率≥80%
- **API测试**：所有端点的功能测试
- **UI测试**：关键用户流程的自动化测试
- **性能测试**：负载测试（100 QPS）、压力测试
- **安全测试**：渗透测试、代码审计
- **用户测试**：内部测试 → 有限用户beta测试 → 全面发布

## 七、附录

### 7.1 UI 原型参考

(这里可以放置UI原型图片或链接)

### 7.2 API 示例

**创建支付链接请求示例:**
```json
POST /api/v1/payment-links
{
  "title": "高级会员订阅",
  "description": "加入我们的高级会员计划，享受专属服务",
  "amount": {
    "type": "FIXED",
    "value": 99.99,
    "currency": "USD"
  },
  "validity": {
    "type": "FIXED",
    "endTime": "2023-12-31T23:59:59Z",
    "maxUsage": 100
  },
  "paymentMethods": ["credit_card", "apple_pay", "google_pay"],
  "notifications": {
    "email": true,
    "webhook": "https://example.com/webhook/payment"
  }
}
```

**创建支付链接响应示例:**
```json
{
  "id": "pl_jK2lm3n4p5q6",
  "shortId": "abCD1234",
  "url": "https://pay.onerway.com/p/abCD1234",
  "qrcodeUrl": "https://pay.onerway.com/qr/pl_jK2lm3n4p5q6",
  "status": "ACTIVE",
  "createdAt": "2023-06-01T10:30:45Z"
}
```

### 7.3 错误码列表

| 错误码 | 描述 | 处理建议 |
|--------|------|----------|
| PL1001 | 链接创建失败 | 检查参数是否完整 |
| PL1002 | 链接已过期 | 联系商户重新创建链接 |
| PL1003 | 链接已达使用上限 | 联系商户重新创建链接 |
| PL2001 | 支付处理失败 | 重试或更换支付方式 |
| PL2002 | 无效的支付方式 | 选择其他支付方式 |
| PL3001 | 商户权限不足 | 联系管理员调整权限 |
| PL9999 | 系统内部错误 | 联系技术支持 |
```

这个详细的功能设计文档覆盖了Onerway Payment Link的全部功能流程、用户交互、技术实现和开发计划。文档结构清晰、内容详实，可以作为开发团队的实施指南。如果您需要对某部分进行调整或补充，请告诉我。
