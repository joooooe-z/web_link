<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢é˜…å®ä¾‹è¯¦æƒ… | Onerway</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-responsive-min.css">
    <link rel="stylesheet" href="../css/lite-main.css">
    <link rel="stylesheet" href="../css/new-nav.css">
</head>
<body>
    <div class="app-container">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="../img/logo-sm.png" alt="Onerway Logo" class="sidebar-logo">
                <h3>å•†æˆ·ä¸­å¿ƒ</h3>
            </div>
            <ul class="sidebar-nav">
                <li class="sidebar-nav-item">
                    <a href="dashboard.html" class="sidebar-nav-link">
                        <i class="nav-icon">ğŸ“Š</i>
                        <span>æ§åˆ¶å°</span>
                    </a>
                    <!-- æ§åˆ¶å°å­èœå• -->
                    <ul class="sidebar-subnav">
                        <li class="sidebar-subnav-item">
                            <a href="manage-links.html" class="sidebar-subnav-link">ç®¡ç†é“¾æ¥</a>
                        </li>
                    </ul>
                </li>
                <!-- è®¢é˜…åŠŸèƒ½å¯¼èˆªå…¥å£ - æ ‡è®°ä¸ºæ¿€æ´» -->
                <li class="sidebar-nav-item active">
                    <a href="subscription-links.html" class="sidebar-nav-link">
                        <i class="nav-icon">ğŸ”„</i>
                        <span>è®¢é˜…ç®¡ç†</span>
                    </a>
                    <!-- è®¢é˜…ç®¡ç†å­èœå• -->
                    <ul class="sidebar-subnav">
                        <li class="sidebar-subnav-item active">
                            <a href="subscription-links.html" class="sidebar-subnav-link">è®¢é˜…é“¾æ¥</a>
                        </li>
                    </ul>
                </li>
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link">
                        <i class="nav-icon">âš™ï¸</i>
                        <span>è®¾ç½®</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div id="subscription-instance-container">
                <!-- é¢åŒ…å±‘å¯¼èˆª -->
                <div class="breadcrumb-container">
                    <ul class="breadcrumb">
                        <li><a href="dashboard.html">æ§åˆ¶å°</a></li>
                        <li><a href="subscription-links.html">è®¢é˜…é“¾æ¥</a></li>
                        <li><a href="#" id="back-to-link">é“¾æ¥è¯¦æƒ…</a></li>
                        <li class="active">è®¢é˜…å®ä¾‹</li>
                    </ul>
                </div>

                <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ¸²æŸ“ -->
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/modules/subscription-core.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–å®ä¾‹ID
            const urlParams = new URLSearchParams(window.location.search);
            const instanceId = urlParams.get('id');
            
            if (!instanceId) {
                showError('æœªæŒ‡å®šè®¢é˜…å®ä¾‹ID');
                return;
            }
            
            // è·å–å®ä¾‹æ•°æ®
            const instance = SubscriptionCore.getSubscriptionInstance(instanceId);
            if (!instance) {
                showError('è®¢é˜…å®ä¾‹ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤');
                return;
            }
            
            // è·å–å…³è”çš„é“¾æ¥
            const link = SubscriptionCore.getSubscriptionLink(instance.subscriptionLinkId);
            if (!link) {
                showError('æ— æ³•æ‰¾åˆ°å…³è”çš„è®¢é˜…é“¾æ¥');
                return;
            }
            
            // æ›´æ–°é¢åŒ…å±‘ä¸­çš„è¿”å›é“¾æ¥
            const backToLinkEl = document.getElementById('back-to-link');
            if (backToLinkEl) {
                backToLinkEl.href = `subscription-details.html?id=${link.id}`;
                backToLinkEl.textContent = link.title;
            }
            
            // è·å–è¯¥å®ä¾‹çš„æ‰€æœ‰äº¤æ˜“
            const transactions = SubscriptionCore.getTransactionsByInstanceId(instanceId);
            
            // æ¸²æŸ“å®ä¾‹è¯¦æƒ…
            renderInstanceDetails(instance, link, transactions);
            
            // ç»‘å®šäº‹ä»¶å¤„ç†
            bindEvents(instance);
        });
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const container = document.getElementById('subscription-instance-container');
            container.innerHTML = `
                <div class="breadcrumb-container">
                    <ul class="breadcrumb">
                        <li><a href="dashboard.html">æ§åˆ¶å°</a></li>
                        <li><a href="subscription-links.html">è®¢é˜…é“¾æ¥</a></li>
                        <li class="active">è®¢é˜…å®ä¾‹</li>
                    </ul>
                </div>
                <div class="error-message">
                    <div class="error-icon">âš ï¸</div>
                    <h3>${message}</h3>
                    <a href="subscription-links.html" class="pure-button primary-button">è¿”å›åˆ—è¡¨</a>
                </div>
            `;
        }
        
        // æ¸²æŸ“å®ä¾‹è¯¦æƒ…
        function renderInstanceDetails(instance, link, transactions) {
            const container = document.getElementById('subscription-instance-container');
            
            // çŠ¶æ€ä¿¡æ¯
            let statusText, statusClass;
            switch(instance.status) {
                case 'active':
                    statusText = 'ç”Ÿæ•ˆä¸­';
                    statusClass = 'badge-success';
                    break;
                case 'trialing':
                    statusText = 'è¯•ç”¨ä¸­';
                    statusClass = 'badge-info';
                    break;
                case 'pending_payment':
                    statusText = 'å¾…æ‰£æ¬¾';
                    statusClass = 'badge-warning';
                    break;
                case 'cancelled':
                    statusText = 'å·²å–æ¶ˆ';
                    statusClass = 'badge-secondary';
                    break;
                case 'completed':
                    statusText = 'å·²å®Œæˆ';
                    statusClass = 'badge-primary';
                    break;
                default:
                    statusText = instance.status;
                    statusClass = 'badge-secondary';
            }
            
            // å‘¨æœŸæ–‡æœ¬
            let frequencyText;
            switch(instance.billingFrequency) {
                case 'daily': frequencyText = 'æ¯å¤©'; break;
                case 'weekly': frequencyText = 'æ¯å‘¨'; break;
                case 'monthly': frequencyText = 'æ¯æœˆ'; break;
                default: frequencyText = instance.billingFrequency;
            }
            
            container.innerHTML = `
                <div class="breadcrumb-container">
                    <ul class="breadcrumb">
                        <li><a href="dashboard.html">æ§åˆ¶å°</a></li>
                        <li><a href="subscription-links.html">è®¢é˜…é“¾æ¥</a></li>
                        <li><a href="subscription-details.html?id=${link.id}">${link.title}</a></li>
                        <li class="active">è®¢é˜…å®ä¾‹</li>
                    </ul>
                </div>
                
                <div class="subscription-module">
                    <div class="module-header">
                        <h2>è®¢é˜…å®ä¾‹è¯¦æƒ…</h2>
                        <a href="subscription-details.html?id=${link.id}" class="pure-button secondary-button">è¿”å›é“¾æ¥è¯¦æƒ…</a>
                    </div>
                    
                    <div class="pure-g">
                        <div class="pure-u-1-2">
                            <div class="detail-section">
                                <h3>åŸºæœ¬ä¿¡æ¯</h3>
                                <table class="pure-table pure-table-bordered">
                                    <tbody>
                                        <tr>
                                            <th>è®¢é˜…åˆåŒå·</th>
                                            <td>${instance.id}</td>
                                        </tr>
                                        <tr>
                                            <th>è®¢é˜…äº§å“</th>
                                            <td>${link.title}</td>
                                        </tr>
                                        <tr>
                                            <th>å®¢æˆ·é‚®ç®±</th>
                                            <td>${instance.customerEmail}</td>
                                        </tr>
                                        <tr>
                                            <th>è®¢é˜…çŠ¶æ€</th>
                                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                                        </tr>
                                        <tr>
                                            <th>æ”¯ä»˜æ–¹å¼</th>
                                            <td>${getPaymentMethodText(instance.paymentMethod)}</td>
                                        </tr>
                                        <tr>
                                            <th>è®¢é˜…å‘¨æœŸ</th>
                                            <td>${frequencyText}</td>
                                        </tr>
                                        <tr>
                                            <th>èµ·å§‹æ—¥æœŸ</th>
                                            <td>${formatDate(instance.startDate)}</td>
                                        </tr>
                                        <tr>
                                            <th>ç»“æŸæ—¥æœŸ</th>
                                            <td>${instance.endDate ? formatDate(instance.endDate) : 'æ— é™æœŸ'}</td>
                                        </tr>
                                        ${instance.trialEndsAt ? `
                                        <tr>
                                            <th>è¯•ç”¨ç»“æŸæ—¥æœŸ</th>
                                            <td>${formatDate(instance.trialEndsAt)}</td>
                                        </tr>
                                        ` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="pure-u-1-2">
                            <div class="detail-section">
                                <h3>è®¢é˜…è¿›åº¦</h3>
                                <table class="pure-table pure-table-bordered">
                                    <tbody>
                                        <tr>
                                            <th>å½“å‰æœŸæ•°</th>
                                            <td>${instance.currentCycle} / ${instance.billingCycles > 0 ? instance.billingCycles : 'æ— é™'}</td>
                                        </tr>
                                        <tr>
                                            <th>ä¸‹æ¬¡æ‰£æ¬¾æ—¥æœŸ</th>
                                            <td>${formatDate(instance.nextBillingDate)}</td>
                                        </tr>
                                        <tr>
                                            <th>ä¸‹æ¬¡æ‰£æ¬¾é‡‘é¢</th>
                                            <td>${formatAmount(instance.nextBillingAmount, instance.currency)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <div class="actions-container">
                                    ${['active', 'trialing'].includes(instance.status) ? `
                                    <button id="record-payment-btn" class="pure-button primary-button">
                                        <i class="icon-money"></i> è®°å½•æ‰£æ¬¾
                                    </button>
                                    <button id="cancel-subscription-btn" class="pure-button secondary-button">
                                        <i class="icon-ban"></i> å–æ¶ˆè®¢é˜…
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>äº¤æ˜“è®°å½•</h3>
                        <table class="pure-table pure-table-bordered">
                            <thead>
                                <tr>
                                    <th>äº¤æ˜“ID</th>
                                    <th>äº¤æ˜“æ—¥æœŸ</th>
                                    <th>é‡‘é¢</th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${transactions.length === 0 
                                    ? '<tr><td colspan="4" class="text-center">æš‚æ— äº¤æ˜“è®°å½•</td></tr>'
                                    : transactions.map(transaction => renderTransactionRow(transaction)).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // æ¸²æŸ“äº¤æ˜“è¡Œ
        function renderTransactionRow(transaction) {
            let statusText, statusClass;
            
            switch(transaction.status) {
                case 'succeeded':
                    statusText = 'æˆåŠŸ';
                    statusClass = 'badge-success';
                    break;
                case 'failed':
                    statusText = 'å¤±è´¥';
                    statusClass = 'badge-danger';
                    break;
                case 'pending':
                    statusText = 'å¤„ç†ä¸­';
                    statusClass = 'badge-warning';
                    break;
                default:
                    statusText = transaction.status;
                    statusClass = 'badge-secondary';
            }
            
            return `
                <tr>
                    <td>${transaction.id}</td>
                    <td>${formatDate(transaction.transactionDate)}</td>
                    <td>${formatAmount(transaction.amount, transaction.currency)}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                </tr>
            `;
        }
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents(instance) {
            // è®°å½•æ‰£æ¬¾æŒ‰é’®
            const recordPaymentBtn = document.getElementById('record-payment-btn');
            if (recordPaymentBtn) {
                recordPaymentBtn.addEventListener('click', function() {
                    if (confirm(`ç¡®å®šè¦è®°å½•ä¸€ç¬” ${formatAmount(instance.nextBillingAmount, instance.currency)} çš„æ‰£æ¬¾å—ï¼Ÿ`)) {
                        try {
                            SubscriptionCore.recordSubscriptionTransaction(instance.id, instance.nextBillingAmount);
                            alert('æ‰£æ¬¾è®°å½•å·²æ·»åŠ ');
                            window.location.reload();
                        } catch (error) {
                            console.error('è®°å½•æ‰£æ¬¾å¤±è´¥:', error);
                            alert('è®°å½•æ‰£æ¬¾å¤±è´¥: ' + error.message);
                        }
                    }
                });
            }
            
            // å–æ¶ˆè®¢é˜…æŒ‰é’®
            const cancelBtn = document.getElementById('cancel-subscription-btn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    if (confirm('ç¡®å®šè¦å–æ¶ˆæ­¤è®¢é˜…å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
                        if (SubscriptionCore.cancelSubscription(instance.id)) {
                            alert('è®¢é˜…å·²æˆåŠŸå–æ¶ˆ');
                            window.location.reload();
                        } else {
                            alert('å–æ¶ˆè®¢é˜…å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    }
                });
            }
        }
        
        // è·å–æ”¯ä»˜æ–¹å¼æ–‡æœ¬
        function getPaymentMethodText(method) {
            switch(method) {
                case 'card': return 'ä¿¡ç”¨å¡æ”¯ä»˜';
                case 'google_pay': return 'Google Pay';
                case 'apple_pay': return 'Apple Pay';
                default: return method;
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleString('zh-CN');
        }
        
        // æ ¼å¼åŒ–é‡‘é¢
        function formatAmount(amount, currency) {
            return new Intl.NumberFormat('zh-CN', { 
                style: 'currency', 
                currency: currency 
            }).format(amount);
        }
    </script>
</body>
</html> 